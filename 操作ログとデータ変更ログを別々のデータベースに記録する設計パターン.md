## はじめに

エンタープライズアプリケーションでは、監査要件やトラブルシューティングのために、ユーザーの操作履歴とデータの変更履歴を記録することが重要です。

本記事では、VB.NET (.NET Framework 4.8) で、操作ログとデータ変更ログを別々のデータベースに記録する設計パターンを解説します。

### 開発環境
- 開発対象: .NET Framework 4.8
- 開発言語: VB.NET
- データベース: SQL Server（他のDBでも応用可能）

### 実装するログの種類

| ログ種別 | 記録内容 | 用途 |
|---------|---------|------|
| **操作ログ** | ログイン、画面遷移、ボタンクリックなど | ユーザー行動の追跡 |
| **データ変更ログ** | INSERT/UPDATE/DELETEの詳細 | データ監査、復元 |

## 1. データベース設計

### 1-1. 操作ログテーブル

```sql
CREATE TABLE OperationLogs (
    LogId BIGINT PRIMARY KEY IDENTITY(1,1),
    LogDateTime DATETIME2 NOT NULL DEFAULT GETDATE(),
    UserId NVARCHAR(50) NOT NULL,
    UserName NVARCHAR(100),
    OperationType NVARCHAR(50) NOT NULL, -- Login, Logout, ScreenOpen, ButtonClick, etc.
    ScreenName NVARCHAR(100),
    OperationDetail NVARCHAR(MAX),
    IpAddress NVARCHAR(50),
    MachineName NVARCHAR(100),
    ApplicationVersion NVARCHAR(50),
    SessionId NVARCHAR(100)
)

CREATE INDEX IX_OperationLogs_UserId ON OperationLogs(UserId)
CREATE INDEX IX_OperationLogs_LogDateTime ON OperationLogs(LogDateTime)
```

### 1-2. データ変更ログテーブル

```sql
CREATE TABLE DataChangeLogs (
    LogId BIGINT PRIMARY KEY IDENTITY(1,1),
    LogDateTime DATETIME2 NOT NULL DEFAULT GETDATE(),
    UserId NVARCHAR(50) NOT NULL,
    UserName NVARCHAR(100),
    TableName NVARCHAR(100) NOT NULL,
    OperationType NVARCHAR(10) NOT NULL, -- INSERT, UPDATE, DELETE
    PrimaryKeyValue NVARCHAR(100),
    ColumnName NVARCHAR(100),
    OldValue NVARCHAR(MAX),
    NewValue NVARCHAR(MAX),
    TransactionId NVARCHAR(100)
)

CREATE INDEX IX_DataChangeLogs_TableName ON DataChangeLogs(TableName)
CREATE INDEX IX_DataChangeLogs_UserId ON DataChangeLogs(UserId)
CREATE INDEX IX_DataChangeLogs_LogDateTime ON DataChangeLogs(LogDateTime)
```

## 2. ログクラスの設計

### 2-1. ログ基底クラス

```vb
Imports System.Data.SqlClient

' ログの基底クラス
Public MustInherit Class BaseLogger
    Protected ConnectionString As String
    Protected CurrentUser As UserInfo
    Protected SessionId As String
    
    Protected Sub New(connectionString As String)
        Me.ConnectionString = connectionString
        Me.SessionId = Guid.NewGuid().ToString()
    End Sub
    
    ' ユーザー情報を設定
    Public Sub SetCurrentUser(user As UserInfo)
        Me.CurrentUser = user
    End Sub
    
    ' データベース接続を取得
    Protected Function GetConnection() As SqlConnection
        Return New SqlConnection(ConnectionString)
    End Function
    
    ' 共通のログ情報を取得
    Protected Function GetCommonLogInfo() As Dictionary(Of String, Object)
        Return New Dictionary(Of String, Object) From {
            {"UserId", If(CurrentUser IsNot Nothing, CurrentUser.UserId, "SYSTEM")},
            {"UserName", If(CurrentUser IsNot Nothing, CurrentUser.UserName, "SYSTEM")},
            {"MachineName", Environment.MachineName},
            {"ApplicationVersion", Application.ProductVersion},
            {"SessionId", SessionId}
        }
    End Function
End Class
```

### 2-2. 操作ログクラス

```vb
Imports System.Data.SqlClient
Imports System.Net
Imports System.Net.NetworkInformation

Public Class OperationLogger
    Inherits BaseLogger
    
    Public Sub New(connectionString As String)
        MyBase.New(connectionString)
    End Sub
    
    ' ログイン記録
    Public Sub LogLogin(userId As String, userName As String, isSuccess As Boolean)
        Dim detail As String = If(isSuccess, "ログイン成功", "ログイン失敗")
        LogOperation("Login", "", detail)
    End Sub
    
    ' ログアウト記録
    Public Sub LogLogout()
        LogOperation("Logout", "", "ログアウト")
    End Sub
    
    ' 画面オープン記録
    Public Sub LogScreenOpen(screenName As String)
        LogOperation("ScreenOpen", screenName, $"画面を開きました: {screenName}")
    End Sub
    
    ' ボタンクリック記録
    Public Sub LogButtonClick(screenName As String, buttonName As String)
        LogOperation("ButtonClick", screenName, $"ボタンクリック: {buttonName}")
    End Sub
    
    ' カスタム操作記録
    Public Sub LogCustomOperation(operationType As String, screenName As String, detail As String)
        LogOperation(operationType, screenName, detail)
    End Sub
    
    ' 操作ログの記録（内部メソッド）
    Private Sub LogOperation(operationType As String, screenName As String, detail As String)
        Try
            Using conn = GetConnection()
                conn.Open()
                
                Using cmd As New SqlCommand()
                    cmd.Connection = conn
                    cmd.CommandText = "
                        INSERT INTO OperationLogs 
                        (UserId, UserName, OperationType, ScreenName, OperationDetail, 
                         IpAddress, MachineName, ApplicationVersion, SessionId)
                        VALUES 
                        (@UserId, @UserName, @OperationType, @ScreenName, @OperationDetail, 
                         @IpAddress, @MachineName, @ApplicationVersion, @SessionId)
                    "
                    
                    Dim commonInfo = GetCommonLogInfo()
                    cmd.Parameters.AddWithValue("@UserId", commonInfo("UserId"))
                    cmd.Parameters.AddWithValue("@UserName", commonInfo("UserName"))
                    cmd.Parameters.AddWithValue("@OperationType", operationType)
                    cmd.Parameters.AddWithValue("@ScreenName", If(screenName, String.Empty))
                    cmd.Parameters.AddWithValue("@OperationDetail", If(detail, String.Empty))
                    cmd.Parameters.AddWithValue("@IpAddress", GetLocalIPAddress())
                    cmd.Parameters.AddWithValue("@MachineName", commonInfo("MachineName"))
                    cmd.Parameters.AddWithValue("@ApplicationVersion", commonInfo("ApplicationVersion"))
                    cmd.Parameters.AddWithValue("@SessionId", commonInfo("SessionId"))
                    
                    cmd.ExecuteNonQuery()
                End Using
            End Using
        Catch ex As Exception
            ' ログ記録失敗時の処理（ファイルログなどにフォールバック）
            Debug.WriteLine($"操作ログの記録に失敗: {ex.Message}")
        End Try
    End Sub
    
    ' ローカルIPアドレスを取得
    Private Function GetLocalIPAddress() As String
        Try
            Dim host = Dns.GetHostEntry(Dns.GetHostName())
            For Each ip In host.AddressList
                If ip.AddressFamily = Net.Sockets.AddressFamily.InterNetwork Then
                    Return ip.ToString()
                End If
            Next
        Catch ex As Exception
            Debug.WriteLine($"IPアドレス取得失敗: {ex.Message}")
        End Try
        Return "Unknown"
    End Function
End Class
```

### 2-3. データ変更ログクラス

```vb
Imports System.Data.SqlClient

Public Class DataChangeLogger
    Inherits BaseLogger
    
    ' 現在のトランザクションID
    Private _currentTransactionId As String
    
    Public Sub New(connectionString As String)
        MyBase.New(connectionString)
    End Sub
    
    ' トランザクション開始
    Public Sub BeginTransaction()
        _currentTransactionId = Guid.NewGuid().ToString()
    End Sub
    
    ' トランザクション終了
    Public Sub EndTransaction()
        _currentTransactionId = Nothing
    End Sub
    
    ' INSERT操作の記録
    Public Sub LogInsert(tableName As String, primaryKeyValue As String, data As Dictionary(Of String, Object))
        For Each kvp In data
            LogChange(tableName, "INSERT", primaryKeyValue, kvp.Key, Nothing, kvp.Value?.ToString())
        Next
    End Sub
    
    ' UPDATE操作の記録
    Public Sub LogUpdate(tableName As String, primaryKeyValue As String, changes As Dictionary(Of String, ChangeInfo))
        For Each kvp In changes
            LogChange(tableName, "UPDATE", primaryKeyValue, kvp.Key, kvp.Value.OldValue, kvp.Value.NewValue)
        Next
    End Sub
    
    ' DELETE操作の記録
    Public Sub LogDelete(tableName As String, primaryKeyValue As String, data As Dictionary(Of String, Object))
        For Each kvp In data
            LogChange(tableName, "DELETE", primaryKeyValue, kvp.Key, kvp.Value?.ToString(), Nothing)
        Next
    End Sub
    
    ' データ変更ログの記録（内部メソッド）
    Private Sub LogChange(tableName As String, operationType As String, primaryKeyValue As String,
                          columnName As String, oldValue As String, newValue As String)
        Try
            Using conn = GetConnection()
                conn.Open()
                
                Using cmd As New SqlCommand()
                    cmd.Connection = conn
                    cmd.CommandText = "
                        INSERT INTO DataChangeLogs 
                        (UserId, UserName, TableName, OperationType, PrimaryKeyValue, 
                         ColumnName, OldValue, NewValue, TransactionId)
                        VALUES 
                        (@UserId, @UserName, @TableName, @OperationType, @PrimaryKeyValue, 
                         @ColumnName, @OldValue, @NewValue, @TransactionId)
                    "
                    
                    Dim commonInfo = GetCommonLogInfo()
                    cmd.Parameters.AddWithValue("@UserId", commonInfo("UserId"))
                    cmd.Parameters.AddWithValue("@UserName", commonInfo("UserName"))
                    cmd.Parameters.AddWithValue("@TableName", tableName)
                    cmd.Parameters.AddWithValue("@OperationType", operationType)
                    cmd.Parameters.AddWithValue("@PrimaryKeyValue", If(primaryKeyValue, String.Empty))
                    cmd.Parameters.AddWithValue("@ColumnName", columnName)
                    cmd.Parameters.AddWithValue("@OldValue", If(oldValue, DBNull.Value))
                    cmd.Parameters.AddWithValue("@NewValue", If(newValue, DBNull.Value))
                    cmd.Parameters.AddWithValue("@TransactionId", If(_currentTransactionId, DBNull.Value))
                    
                    cmd.ExecuteNonQuery()
                End Using
            End Using
        Catch ex As Exception
            Debug.WriteLine($"データ変更ログの記録に失敗: {ex.Message}")
        End Try
    End Sub
End Class

' 変更情報を保持するクラス
Public Class ChangeInfo
    Public Property OldValue As String
    Public Property NewValue As String
    
    Public Sub New(oldValue As String, newValue As String)
        Me.OldValue = oldValue
        Me.NewValue = newValue
    End Sub
End Class
```

### 2-4. ログマネージャークラス（Singleton）

```vb
Public Class LogManager
    Private Shared _instance As LogManager
    Private Shared ReadOnly _lock As New Object()
    
    Private _operationLogger As OperationLogger
    Private _dataChangeLogger As DataChangeLogger
    Private _isInitialized As Boolean = False
    
    ' Singletonインスタンスの取得
    Public Shared ReadOnly Property Instance As LogManager
        Get
            If _instance Is Nothing Then
                SyncLock _lock
                    If _instance Is Nothing Then
                        _instance = New LogManager()
                    End If
                End SyncLock
            End If
            Return _instance
        End Get
    End Property
    
    Private Sub New()
        ' プライベートコンストラクタ
    End Sub
    
    ' ログシステムの初期化
    Public Sub Initialize(operationLogConnectionString As String, dataChangeLogConnectionString As String)
        SyncLock _lock
            If _isInitialized Then
                Throw New InvalidOperationException("LogManager is already initialized.")
            End If
            
            _operationLogger = New OperationLogger(operationLogConnectionString)
            _dataChangeLogger = New DataChangeLogger(dataChangeLogConnectionString)
            _isInitialized = True
        End SyncLock
    End Sub
    
    ' ユーザー情報を設定
    Public Sub SetCurrentUser(user As UserInfo)
        If Not _isInitialized Then
            Throw New InvalidOperationException("LogManager is not initialized.")
        End If
        
        _operationLogger.SetCurrentUser(user)
        _dataChangeLogger.SetCurrentUser(user)
    End Sub
    
    ' 操作ログ取得
    Public ReadOnly Property Operation As OperationLogger
        Get
            If Not _isInitialized Then
                Throw New InvalidOperationException("LogManager is not initialized.")
            End If
            Return _operationLogger
        End Get
    End Property
    
    ' データ変更ログ取得
    Public ReadOnly Property DataChange As DataChangeLogger
        Get
            If Not _isInitialized Then
                Throw New InvalidOperationException("LogManager is not initialized.")
            End If
            Return _dataChangeLogger
        End Get
    End Property
End Class
```

## 3. ユーザー情報クラス

```vb
Public Class UserInfo
    Public Property UserId As String
    Public Property UserName As String
    Public Property Email As String
    Public Property RoleId As Integer
    Public Property RoleName As String
    Public Property DepartmentId As Integer
    Public Property DepartmentName As String
    
    Public Sub New()
    End Sub
    
    Public Sub New(userId As String, userName As String)
        Me.UserId = userId
        Me.UserName = userName
    End Sub
End Class
```

## 4. アプリケーション起動フロー

### 4-1. Program.vb（エントリーポイント）

```vb
Imports System.Windows.Forms
Imports System.Configuration

Module Program
    <STAThread>
    Sub Main()
        Application.EnableVisualStyles()
        Application.SetCompatibleTextRenderingDefault(False)
        
        Try
            ' 1. 設定ファイルから接続文字列を読み込み
            Dim operationLogConnectionString = ConfigurationManager.ConnectionStrings("OperationLogDB").ConnectionString
            Dim dataChangeLogConnectionString = ConfigurationManager.ConnectionStrings("DataChangeLogDB").ConnectionString
            Dim mainDbConnectionString = ConfigurationManager.ConnectionStrings("MainDB").ConnectionString
            
            ' 2. ログマネージャーの初期化
            LogManager.Instance.Initialize(operationLogConnectionString, dataChangeLogConnectionString)
            
            ' 3. ログインフォームの表示
            Dim loginForm As New LoginForm()
            If loginForm.ShowDialog() = DialogResult.OK Then
                ' 4. ログイン成功：ユーザー情報を設定
                LogManager.Instance.SetCurrentUser(loginForm.LoggedInUser)
                
                ' 5. ログイン操作を記録
                LogManager.Instance.Operation.LogLogin(
                    loginForm.LoggedInUser.UserId,
                    loginForm.LoggedInUser.UserName,
                    True
                )
                
                ' 6. メインフォームを起動
                Application.Run(New MainForm(mainDbConnectionString))
                
                ' 7. アプリケーション終了時：ログアウトを記録
                LogManager.Instance.Operation.LogLogout()
            Else
                ' ログイン失敗
                Application.Exit()
            End If
            
        Catch ex As Exception
            MessageBox.Show(
                $"アプリケーションの起動に失敗しました。{Environment.NewLine}{ex.Message}",
                "エラー",
                MessageBoxButtons.OK,
                MessageBoxIcon.Error
            )
        End Try
    End Sub
End Module
```

### 4-2. App.config（設定ファイル）

```xml
<?xml version="1.0" encoding="utf-8" ?>
<configuration>
  <connectionStrings>
    <!-- メインデータベース -->
    <add name="MainDB" 
         connectionString="Data Source=SERVER01;Initial Catalog=MainDB;Integrated Security=True" 
         providerName="System.Data.SqlClient" />
    
    <!-- 操作ログデータベース -->
    <add name="OperationLogDB" 
         connectionString="Data Source=SERVER01;Initial Catalog=OperationLogDB;Integrated Security=True" 
         providerName="System.Data.SqlClient" />
    
    <!-- データ変更ログデータベース -->
    <add name="DataChangeLogDB" 
         connectionString="Data Source=SERVER01;Initial Catalog=DataChangeLogDB;Integrated Security=True" 
         providerName="System.Data.SqlClient" />
  </connectionStrings>
  
  <appSettings>
    <add key="ApplicationName" value="SalesManagementSystem" />
    <add key="Version" value="1.0.0" />
  </appSettings>
</configuration>
```

### 4-3. LoginForm.vb（ログインフォーム）

```vb
Imports System.Data.SqlClient
Imports System.Windows.Forms

Public Class LoginForm
    Private txtUserId As TextBox
    Private txtPassword As TextBox
    Private btnLogin As Button
    Private _loggedInUser As UserInfo
    
    Public ReadOnly Property LoggedInUser As UserInfo
        Get
            Return _loggedInUser
        End Get
    End Property
    
    Private Sub BtnLogin_Click(sender As Object, e As EventArgs) Handles btnLogin.Click
        Dim userId = txtUserId.Text.Trim()
        Dim password = txtPassword.Text
        
        If String.IsNullOrWhiteSpace(userId) OrElse String.IsNullOrWhiteSpace(password) Then
            MessageBox.Show("ユーザーIDとパスワードを入力してください", "入力エラー", MessageBoxButtons.OK, MessageBoxIcon.Warning)
            Return
        End If
        
        Try
            ' ユーザー認証
            _loggedInUser = AuthenticateUser(userId, password)
            
            If _loggedInUser IsNot Nothing Then
                Me.DialogResult = DialogResult.OK
                Me.Close()
            Else
                MessageBox.Show("ユーザーIDまたはパスワードが正しくありません", "認証エラー", MessageBoxButtons.OK, MessageBoxIcon.Error)
                
                ' ログイン失敗を記録（ユーザー情報なしで記録）
                Try
                    Dim tempUser As New UserInfo(userId, "Unknown")
                    LogManager.Instance.SetCurrentUser(tempUser)
                    LogManager.Instance.Operation.LogLogin(userId, "Unknown", False)
                Catch ex As Exception
                    Debug.WriteLine($"ログイン失敗ログの記録エラー: {ex.Message}")
                End Try
            End If
            
        Catch ex As Exception
            MessageBox.Show($"ログイン処理中にエラーが発生しました: {ex.Message}", "エラー", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub
    
    Private Function AuthenticateUser(userId As String, password As String) As UserInfo
        ' 実際の認証処理（データベースから取得）
        Dim connectionString = ConfigurationManager.ConnectionStrings("MainDB").ConnectionString
        
        Using conn As New SqlConnection(connectionString)
            conn.Open()
            
            Using cmd As New SqlCommand()
                cmd.Connection = conn
                cmd.CommandText = "
                    SELECT u.UserId, u.UserName, u.Email, u.RoleId, r.RoleName, u.DepartmentId, d.DepartmentName
                    FROM Users u
                    INNER JOIN Roles r ON u.RoleId = r.RoleId
                    LEFT JOIN Departments d ON u.DepartmentId = d.DepartmentId
                    WHERE u.UserId = @UserId AND u.Password = @Password AND u.IsActive = 1
                "
                
                cmd.Parameters.AddWithValue("@UserId", userId)
                cmd.Parameters.AddWithValue("@Password", password) ' 実際にはハッシュ化したパスワードと比較
                
                Using reader = cmd.ExecuteReader()
                    If reader.Read() Then
                        Return New UserInfo() With {
                            .UserId = reader("UserId").ToString(),
                            .UserName = reader("UserName").ToString(),
                            .Email = If(IsDBNull(reader("Email")), String.Empty, reader("Email").ToString()),
                            .RoleId = CInt(reader("RoleId")),
                            .RoleName = reader("RoleName").ToString(),
                            .DepartmentId = If(IsDBNull(reader("DepartmentId")), 0, CInt(reader("DepartmentId"))),
                            .DepartmentName = If(IsDBNull(reader("DepartmentName")), String.Empty, reader("DepartmentName").ToString())
                        }
                    End If
                End Using
            End Using
        End Using
        
        Return Nothing
    End Function
End Class
```

## 5. 実際の使用例

### 5-1. メインフォームでの操作ログ記録

```vb
Public Class MainForm
    Private Sub MainForm_Load(sender As Object, e As EventArgs) Handles MyBase.Load
        ' 画面オープンを記録
        LogManager.Instance.Operation.LogScreenOpen("MainForm")
    End Sub
    
    Private Sub BtnCustomerList_Click(sender As Object, e As EventArgs) Handles BtnCustomerList.Click
        ' ボタンクリックを記録
        LogManager.Instance.Operation.LogButtonClick("MainForm", "顧客一覧")
        
        ' 顧客一覧フォームを開く
        Dim customerListForm As New CustomerListForm()
        customerListForm.ShowDialog()
    End Sub
    
    Private Sub BtnExport_Click(sender As Object, e As EventArgs) Handles BtnExport.Click
        ' カスタム操作を記録
        LogManager.Instance.Operation.LogCustomOperation(
            "DataExport",
            "MainForm",
            $"顧客データをエクスポート: {DateTime.Now:yyyy-MM-dd HH:mm:ss}"
        )
        
        ' エクスポート処理
        ExportCustomerData()
    End Sub
End Class
```

### 5-2. データ更新時のデータ変更ログ記録

```vb
Public Class CustomerEditForm
    Private _customerId As Integer
    Private _originalData As Dictionary(Of String, Object)
    
    Private Sub LoadCustomerData()
        ' 顧客データを読み込み（元データを保持）
        _originalData = New Dictionary(Of String, Object)
        
        Using conn As New SqlConnection(connectionString)
            conn.Open()
            Using cmd As New SqlCommand("SELECT * FROM Customers WHERE CustomerId = @CustomerId", conn)
                cmd.Parameters.AddWithValue("@CustomerId", _customerId)
                
                Using reader = cmd.ExecuteReader()
                    If reader.Read() Then
                        txtCustomerName.Text = reader("CustomerName").ToString()
                        txtEmail.Text = reader("Email").ToString()
                        txtPhone.Text = reader("Phone").ToString()
                        
                        ' 元データを保存
                        _originalData.Add("CustomerName", reader("CustomerName"))
                        _originalData.Add("Email", reader("Email"))
                        _originalData.Add("Phone", reader("Phone"))
                    End If
                End Using
            End Using
        End Using
    End Sub
    
    Private Sub BtnSave_Click(sender As Object, e As EventArgs) Handles BtnSave.Click
        Try
            ' トランザクション開始
            LogManager.Instance.DataChange.BeginTransaction()
            
            ' 変更内容を記録
            Dim changes As New Dictionary(Of String, ChangeInfo)
            
            If txtCustomerName.Text <> _originalData("CustomerName").ToString() Then
                changes.Add("CustomerName", New ChangeInfo(
                    _originalData("CustomerName").ToString(),
                    txtCustomerName.Text
                ))
            End If
            
            If txtEmail.Text <> _originalData("Email").ToString() Then
                changes.Add("Email", New ChangeInfo(
                    _originalData("Email").ToString(),
                    txtEmail.Text
                ))
            End If
            
            If txtPhone.Text <> _originalData("Phone").ToString() Then
                changes.Add("Phone", New ChangeInfo(
                    _originalData("Phone").ToString(),
                    txtPhone.Text
                ))
            End If
            
            ' データベース更新
            UpdateCustomer()
            
            ' データ変更ログを記録
            If changes.Count > 0 Then
                LogManager.Instance.DataChange.LogUpdate("Customers", _customerId.ToString(), changes)
            End If
            
            ' トランザクション終了
            LogManager.Instance.DataChange.EndTransaction()
            
            MessageBox.Show("保存しました", "成功", MessageBoxButtons.OK, MessageBoxIcon.Information)
            Me.Close()
            
        Catch ex As Exception
            MessageBox.Show($"保存に失敗しました: {ex.Message}", "エラー", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub
    
    Private Sub UpdateCustomer()
        Using conn As New SqlConnection(connectionString)
            conn.Open()
            
            Using cmd As New SqlCommand()
                cmd.Connection = conn
                cmd.CommandText = "
                    UPDATE Customers
                    SET CustomerName = @CustomerName,
                        Email = @Email,
                        Phone = @Phone,
                        UpdatedBy = @UpdatedBy,
                        UpdatedAt = GETDATE()
                    WHERE CustomerId = @CustomerId
                "
                
                cmd.Parameters.AddWithValue("@CustomerId", _customerId)
                cmd.Parameters.AddWithValue("@CustomerName", txtCustomerName.Text)
                cmd.Parameters.AddWithValue("@Email", txtEmail.Text)
                cmd.Parameters.AddWithValue("@Phone", txtPhone.Text)
                cmd.Parameters.AddWithValue("@UpdatedBy", LogManager.Instance.Operation.CurrentUser.UserId)
                
                cmd.ExecuteNonQuery()
            End Using
        End Using
    End Sub
End Class
```

### 5-3. データ挿入時のログ記録

```vb
Private Sub InsertNewCustomer()
    Dim newCustomerId As Integer
    
    Try
        ' トランザクション開始
        LogManager.Instance.DataChange.BeginTransaction()
        
        ' データベースに挿入
        Using conn As New SqlConnection(connectionString)
            conn.Open()
            
            Using cmd As New SqlCommand()
                cmd.Connection = conn
                cmd.CommandText = "
                    INSERT INTO Customers (CustomerName, Email, Phone, CreatedBy, CreatedAt)
                    VALUES (@CustomerName, @Email, @Phone, @CreatedBy, GETDATE());
                    SELECT CAST(SCOPE_IDENTITY() AS INT);
                "
                
                cmd.Parameters.AddWithValue("@CustomerName", txtCustomerName.Text)
                cmd.Parameters.AddWithValue("@Email", txtEmail.Text)
                cmd.Parameters.AddWithValue("@Phone", txtPhone.Text)
                cmd.Parameters.AddWithValue("@CreatedBy", LogManager.Instance.Operation.CurrentUser.UserId)
                
                newCustomerId = CInt(cmd.ExecuteScalar())
            End Using
        End Using
        
        ' データ変更ログを記録
        Dim insertData As New Dictionary(Of String, Object) From {
            {"CustomerName", txtCustomerName.Text},
            {"Email", txtEmail.Text},
            {"Phone", txtPhone.Text}
        }
        
        LogManager.Instance.DataChange.LogInsert("Customers", newCustomerId.ToString(), insertData)
        
        ' トランザクション終了
        LogManager.Instance.DataChange.EndTransaction()
        
        MessageBox.Show("登録しました", "成功", MessageBoxButtons.OK, MessageBoxIcon.Information)
        
    Catch ex As Exception
        MessageBox.Show($"登録に失敗しました: {ex.Message}", "エラー", MessageBoxButtons.OK, MessageBoxIcon.Error)
    End Try
End Sub
```

### 5-4. データ削除時のログ記録

```vb
Private Sub DeleteCustomer(customerId As Integer)
    Try
        ' 削除前のデータを取得
        Dim originalData As New Dictionary(Of String, Object)
        
        Using conn As New SqlConnection(connectionString)
            conn.Open()
            
            Using cmd As New SqlCommand("SELECT * FROM Customers WHERE CustomerId = @CustomerId", conn)
                cmd.Parameters.AddWithValue("@CustomerId", customerId)
                
                Using reader = cmd.ExecuteReader()
                    If reader.Read() Then
                        originalData.Add("CustomerName", reader("CustomerName"))
                        originalData.Add("Email", reader("Email"))
                        originalData.Add("Phone", reader("Phone"))
                    End If
                End Using
            End Using
        End Using
        
        ' トランザクション開始
        LogManager.Instance.DataChange.BeginTransaction()
        
        ' データベースから削除
        Using conn As New SqlConnection(connectionString)
            conn.Open()
            
            Using cmd As New SqlCommand()
                cmd.Connection = conn
                cmd.CommandText = "DELETE FROM Customers WHERE CustomerId = @CustomerId"
                cmd.Parameters.AddWithValue("@CustomerId", customerId)
                cmd.ExecuteNonQuery()
            End Using
        End Using
        
        ' データ変更ログを記録
        LogManager.Instance.DataChange.LogDelete("Customers", customerId.ToString(), originalData)
        
        ' トランザクション終了
        LogManager.Instance.DataChange.EndTransaction()
        
        MessageBox.Show("削除しました", "成功", MessageBoxButtons.OK, MessageBoxIcon.Information)
        
    Catch ex As Exception
        MessageBox.Show($"削除に失敗しました: {ex.Message}", "エラー", MessageBoxButtons.OK, MessageBoxIcon.Error)
    End Try
End Sub
```

## 6. より良い設計の提案

### 6-1. 非同期ログ記録（パフォーマンス向上）

```vb
Imports System.Collections.Concurrent
Imports System.Threading

Public Class AsyncLogger
    Private ReadOnly _logQueue As New BlockingCollection(Of Action)
    Private ReadOnly _workerThread As Thread
    Private _isRunning As Boolean = True
    
    Public Sub New()
        _workerThread = New Thread(AddressOf ProcessLogQueue)
        _workerThread.IsBackground = True
        _workerThread.Start()
    End Sub
    
    Public Sub QueueLog(logAction As Action)
        _logQueue.Add(logAction)
    End Sub
    
    Private Sub ProcessLogQueue()
        While _isRunning
            Try
                Dim logAction = _logQueue.Take() ' ブロッキング待機
                logAction.Invoke()
            Catch ex As Exception
                Debug.WriteLine($"ログ処理エラー: {ex.Message}")
            End Try
        End While
    End Sub
    
    Public Sub Shutdown()
        _isRunning = False
        _logQueue.CompleteAdding()
        _workerThread.Join(TimeSpan.FromSeconds(5))
    End Sub
End Class

' 使用例
Public Class OperationLoggerAsync
    Inherits OperationLogger
    
    Private _asyncLogger As AsyncLogger
    
    Public Sub New(connectionString As String)
        MyBase.New(connectionString)
        _asyncLogger = New AsyncLogger()
    End Sub
    
    Public Overloads Sub LogOperation(operationType As String, screenName As String, detail As String)
        ' 非同期でログ記録をキューに追加
        _asyncLogger.QueueLog(Sub()
            MyBase.LogOperation(operationType, screenName, detail)
        End Sub)
    End Sub
End Class
```

### 6-2. ログローテーション機能

```vb
Public Class LogRotationManager
    Private ReadOnly _connectionString As String
    Private ReadOnly _retentionDays As Integer
    
    Public Sub New(connectionString As String, retentionDays As Integer)
        _connectionString = connectionString
        _retentionDays = retentionDays
    End Sub
    
    ' 古いログを削除
    Public Sub RotateLogs()
        Try
            Using conn As New SqlConnection(_connectionString)
                conn.Open()
                
                ' 操作ログの削除
                Using cmd As New SqlCommand()
                    cmd.Connection = conn
                    cmd.CommandText = $"DELETE FROM OperationLogs WHERE LogDateTime < DATEADD(DAY, -{_retentionDays}, GETDATE())"
                    Dim deletedRows = cmd.ExecuteNonQuery()
                    Debug.WriteLine($"操作ログ {deletedRows} 件を削除しました")
                End Using
                
                ' データ変更ログの削除
                Using cmd As New SqlCommand()
                    cmd.Connection = conn
                    cmd.CommandText = $"DELETE FROM DataChangeLogs WHERE LogDateTime < DATEADD(DAY, -{_retentionDays}, GETDATE())"
                    Dim deletedRows = cmd.ExecuteNonQuery()
                    Debug.WriteLine($"データ変更ログ {deletedRows} 件を削除しました")
                End Using
            End Using
        Catch ex As Exception
            Debug.WriteLine($"ログローテーションエラー: {ex.Message}")
        End Try
    End Sub
End Class
```

### 6-3. 設定ファイルによる柔軟な管理

```xml
<!-- App.config に追加 -->
<appSettings>
  <!-- ログ設定 -->
  <add key="LogRetentionDays" value="365" />
  <add key="EnableAsyncLogging" value="true" />
  <add key="LogLevel" value="Info" /> <!-- Debug, Info, Warning, Error -->
  <add key="EnableOperationLog" value="true" />
  <add key="EnableDataChangeLog" value="true" />
</appSettings>
```

## 7. セキュリティ考慮事項

### 7-1. パスワードのログ記録禁止

```vb
' パスワードフィールドを除外
Public Function SanitizeLogData(data As Dictionary(Of String, Object)) As Dictionary(Of String, Object)
    Dim sanitized As New Dictionary(Of String, Object)
    Dim sensitiveFields As String() = {"Password", "PasswordHash", "CreditCardNumber", "SSN"}
    
    For Each kvp In data
        If Not sensitiveFields.Contains(kvp.Key) Then
            sanitized.Add(kvp.Key, kvp.Value)
        Else
            sanitized.Add(kvp.Key, "***REDACTED***")
        End If
    Next
    
    Return sanitized
End Function
```

### 7-2. ログアクセス権限の制限

```sql
-- ログ参照用の読み取り専用ユーザーを作成
CREATE USER LogReader WITH PASSWORD = 'SecurePassword123!';
GRANT SELECT ON OperationLogs TO LogReader;
GRANT SELECT ON DataChangeLogs TO LogReader;

-- アプリケーション用のユーザーには書き込み権限のみ
CREATE USER LogWriter WITH PASSWORD = 'SecurePassword456!';
GRANT INSERT ON OperationLogs TO LogWriter;
GRANT INSERT ON DataChangeLogs TO LogWriter;
```

## 8. まとめ

### 実装のポイント

| 項目 | 推奨方法 |
|------|---------|
| **アーキテクチャ** | Singletonパターンでログマネージャーを一元管理 |
| **データベース分離** | 操作ログとデータ変更ログは別DBに分離 |
| **初期化タイミング** | アプリ起動時に接続情報を設定 |
| **ユーザー情報** | ログイン成功後に設定 |
| **パフォーマンス** | 非同期ログ記録を検討 |
| **保守性** | ログローテーションを実装 |
| **セキュリティ** | 機密情報をログに記録しない |

### 起動フロー
```
1. App.config から接続文字列を読み込み
   ↓
2. LogManager を初期化（DB接続情報を設定）
   ↓
3. ログインフォームを表示
   ↓
4. 認証成功後、LogManager にユーザー情報を設定
   ↓
5. ログイン操作を記録
   ↓
6. メインフォーム起動
   ↓
7. 各画面で操作ログ・データ変更ログを記録
   ↓
8. アプリ終了時にログアウトを記録
```

### 代替案との比較

| 方式 | メリット | デメリット |
|------|---------|-----------|
| **本記事の方式** | シンプル、柔軟性高い | 初期実装が必要 |
| **NLog/log4net** | 実績豊富、機能充実 | カスタマイズが複雑 |
| **Entity Framework** | ORMと統合可能 | パフォーマンスに注意 |

## おわりに

本記事では、操作ログとデータ変更ログを別々のデータベースに記録する設計パターンを解説しました。

この設計により：
- ユーザーの行動を追跡できる
- データの変更履歴を完全に記録できる
- 監査要件に対応できる
- トラブルシューティングが容易になる

実際のプロジェクトでは、要件に応じて非同期ログ記録やログローテーションなどの機能を追加することをお勧めします。
