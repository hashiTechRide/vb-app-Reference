# LockService 楽観的・悲観的ロック併用版

## 1. 基本クラス定義

```vb.net
''' <summary>
''' ロックタイプ
''' </summary>
Public Enum LockType
    Pessimistic  ' 悲観的ロック（SELECT FOR UPDATE）
    Optimistic   ' 楽観的ロック（バージョンチェック）
End Enum

''' <summary>
''' ロック対象情報
''' </summary>
Public Class LockTarget
    Public Property TableName As String
    Public Property WhereClause As String
    Public Property Parameters As Dictionary(Of String, Object)
    Public Property LockType As LockType
    Public Property VersionColumn As String  ' 楽観的ロック用（デフォルト: "UPDATE_VERSION"）
    
    Public Sub New(tableName As String, 
                   whereClause As String, 
                   parameters As Dictionary(Of String, Object),
                   Optional lockType As LockType = LockType.Pessimistic,
                   Optional versionColumn As String = "UPDATE_VERSION")
        Me.TableName = tableName
        Me.WhereClause = whereClause
        Me.Parameters = parameters
        Me.LockType = lockType
        Me.VersionColumn = versionColumn
    End Sub
End Class

''' <summary>
''' 楽観的ロック情報保持用
''' </summary>
Public Class OptimisticLockInfo
    Public Property TableName As String
    Public Property WhereClause As String
    Public Property Parameters As Dictionary(Of String, Object)
    Public Property VersionColumn As String
    Public Property OriginalVersion As Integer  ' 取得時のバージョン
End Class
```

## 2. LockService実装

```vb.net
Public Class LockService
    Implements IDisposable

    Private _connection As OracleConnection
    Private _transaction As OracleTransaction
    Private _lockCommands As New List(Of OracleCommand)
    Private _optimisticLocks As New List(Of OptimisticLockInfo)
    Private _isLocked As Boolean = False

    Public Sub New(connectionString As String)
        _connection = New OracleConnection(connectionString)
    End Sub

    ''' <summary>
    ''' ロック取得（悲観的・楽観的の混在対応）
    ''' </summary>
    Public Function AcquireLocks(lockTargets As List(Of LockTarget)) As Boolean
        If lockTargets Is Nothing OrElse lockTargets.Count = 0 Then
            Return False
        End If

        Try
            If _connection.State <> ConnectionState.Open Then
                _connection.Open()
            End If

            _transaction = _connection.BeginTransaction()
            _lockCommands.Clear()
            _optimisticLocks.Clear()

            ' 各テーブルに対してロック取得
            For Each target In lockTargets
                Select Case target.LockType
                    Case LockType.Pessimistic
                        If Not AcquirePessimisticLock(target) Then
                            ReleaseLock()
                            Return False
                        End If
                        
                    Case LockType.Optimistic
                        If Not PrepareOptimisticLock(target) Then
                            ReleaseLock()
                            Return False
                        End If
                End Select
            Next

            _isLocked = True
            Return True

        Catch ex As Exception
            MessageBox.Show($"ロック取得エラー: {ex.Message}", "エラー", MessageBoxButtons.OK, MessageBoxIcon.Error)
            ReleaseLock()
            Return False
        End Try
    End Function

    ''' <summary>
    ''' 悲観的ロック取得
    ''' </summary>
    Private Function AcquirePessimisticLock(target As LockTarget) As Boolean
        Dim sql As String = $"SELECT * FROM {target.TableName} WHERE {target.WhereClause} FOR UPDATE NOWAIT"
        Dim cmd As New OracleCommand(sql, _connection, _transaction)

        If target.Parameters IsNot Nothing Then
            For Each param In target.Parameters
                cmd.Parameters.Add(New OracleParameter(param.Key, param.Value))
            Next
        End If

        Try
            Dim reader As OracleDataReader = cmd.ExecuteReader()
            If Not reader.HasRows Then
                reader.Close()
                MessageBox.Show($"テーブル '{target.TableName}' に対象レコードが存在しません。", 
                                "エラー", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                Return False
            End If
            reader.Close()
            _lockCommands.Add(cmd)
            Return True
            
        Catch ex As OracleException
            If ex.Number = 54 Then  ' ORA-00054
                MessageBox.Show($"テーブル '{target.TableName}' は他のユーザーが編集中です。", 
                                "ロックエラー", MessageBoxButtons.OK, MessageBoxIcon.Warning)
            End If
            Return False
        End Try
    End Function

    ''' <summary>
    ''' 楽観的ロック準備（バージョン取得のみ）
    ''' </summary>
    Private Function PrepareOptimisticLock(target As LockTarget) As Boolean
        Dim sql As String = $"SELECT {target.VersionColumn} FROM {target.TableName} WHERE {target.WhereClause}"
        
        Using cmd As New OracleCommand(sql, _connection, _transaction)
            If target.Parameters IsNot Nothing Then
                For Each param In target.Parameters
                    cmd.Parameters.Add(New OracleParameter(param.Key, param.Value))
                Next
            End If

            Dim version As Object = cmd.ExecuteScalar()
            If version Is Nothing OrElse IsDBNull(version) Then
                MessageBox.Show($"テーブル '{target.TableName}' に対象レコードが存在しません。", 
                                "エラー", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                Return False
            End If

            ' バージョン情報を保持
            _optimisticLocks.Add(New OptimisticLockInfo With {
                .TableName = target.TableName,
                .WhereClause = target.WhereClause,
                .Parameters = target.Parameters,
                .VersionColumn = target.VersionColumn,
                .OriginalVersion = Convert.ToInt32(version)
            })
            Return True
        End Using
    End Function

    ''' <summary>
    ''' データ更新（楽観的ロックチェック付き）
    ''' </summary>
    Public Function UpdateData(sql As String, 
                               parameters As Dictionary(Of String, Object), 
                               Optional tableName As String = Nothing) As Boolean
        If Not _isLocked Then
            Throw New InvalidOperationException("ロックが取得されていません。")
        End If

        Try
            Using cmd As New OracleCommand(sql, _connection, _transaction)
                If parameters IsNot Nothing Then
                    For Each param In parameters
                        cmd.Parameters.Add(New OracleParameter(param.Key, param.Value))
                    Next
                End If
                
                Dim rowsAffected As Integer = cmd.ExecuteNonQuery()
                
                ' 楽観的ロック対象で更新行数が0の場合は競合
                If Not String.IsNullOrEmpty(tableName) AndAlso rowsAffected = 0 Then
                    MessageBox.Show($"他のユーザーによってデータが更新されています。{vbCrLf}最新データを再読み込みしてください。",
                                    "更新競合", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                    Return False
                End If
            End Using
            Return True
            
        Catch ex As Exception
            MessageBox.Show($"更新エラー: {ex.Message}", "エラー", MessageBoxButtons.OK, MessageBoxIcon.Error)
            Return False
        End Try
    End Function

    ''' <summary>
    ''' ロック解放
    ''' </summary>
    Public Sub ReleaseLock()
        Try
            If _isLocked AndAlso _transaction IsNot Nothing Then
                _transaction.Rollback()
                _isLocked = False
            End If
        Finally
            For Each cmd In _lockCommands
                cmd?.Dispose()
            Next
            _lockCommands.Clear()
            _optimisticLocks.Clear()

            If _transaction IsNot Nothing Then
                _transaction.Dispose()
                _transaction = Nothing
            End If
        End Try
    End Sub

    ''' <summary>
    ''' コミット
    ''' </summary>
    Public Sub Commit()
        If _isLocked AndAlso _transaction IsNot Nothing Then
            _transaction.Commit()
            _isLocked = False
        End If
    End Sub

    Public ReadOnly Property IsLocked As Boolean
        Get
            Return _isLocked
        End Get
    End Property

    Public Sub Dispose() Implements IDisposable.Dispose
        ReleaseLock()
        If _connection IsNot Nothing Then
            If _connection.State = ConnectionState.Open Then
                _connection.Close()
            End If
            _connection.Dispose()
        End If
    End Sub
End Class
```

## 3. 使用例

```vb.net
Public Class OrderEditControl
    Inherits UserControl
    Implements IEditableControl

    Private _parentForm As MainEditForm
    Private _headerVersion As Integer  ' ヘッダのバージョン保持

    ''' <summary>
    ''' ロック対象定義
    ''' </summary>
    Public Function GetLockTargets() As List(Of LockTarget) Implements IEditableControl.GetLockTargets
        Dim targets As New List(Of LockTarget)
        
        ' ヘッダ: 楽観的ロック
        targets.Add(New LockTarget(
            "ORDER_HEADERS",
            "ORDER_ID = :orderId",
            New Dictionary(Of String, Object) From {{"orderId", _parentForm.RecordId}},
            LockType.Optimistic,
            "UPDATE_VERSION"
        ))
        
        ' Detail: 悲観的ロック（現在ページのみ）
        targets.Add(New LockTarget(
            "ORDER_DETAILS",
            "ORDER_ID = :orderId AND LINE_NO BETWEEN :start AND :end",
            New Dictionary(Of String, Object) From {
                {"orderId", _parentForm.RecordId},
                {"start", 1},
                {"end", 20}
            },
            LockType.Pessimistic
        ))
        
        Return targets
    End Function

    ''' <summary>
    ''' データ読み込み
    ''' </summary>
    Private Sub LoadData()
        Using conn As New OracleConnection(ConfigurationManager.ConnectionStrings("OracleDB").ConnectionString)
            conn.Open()
            
            ' ヘッダ取得（バージョン保持）
            Dim sql As String = "SELECT * FROM ORDER_HEADERS WHERE ORDER_ID = :orderId"
            Using cmd As New OracleCommand(sql, conn)
                cmd.Parameters.Add(New OracleParameter("orderId", _parentForm.RecordId))
                Using reader As OracleDataReader = cmd.ExecuteReader()
                    If reader.Read() Then
                        txtCustomerName.Text = reader("CUSTOMER_NAME").ToString()
                        _headerVersion = Convert.ToInt32(reader("UPDATE_VERSION"))
                    End If
                End Using
            End Using
        End Using
    End Sub

    ''' <summary>
    ''' 保存処理
    ''' </summary>
    Private Sub btnSave_Click(sender As Object, e As EventArgs) Handles btnSave.Click
        Try
            ' ヘッダ更新（楽観的ロック - WHERE句にバージョン条件）
            Dim headerSql As String = @"
                UPDATE ORDER_HEADERS 
                SET 
                    CUSTOMER_NAME = :name,
                    UPDATE_VERSION = UPDATE_VERSION + 1,
                    UPDATE_DATE = SYSDATE
                WHERE 
                    ORDER_ID = :orderId 
                    AND UPDATE_VERSION = :version"
                    
            Dim headerParams As New Dictionary(Of String, Object) From {
                {"name", txtCustomerName.Text},
                {"orderId", _parentForm.RecordId},
                {"version", _headerVersion}
            }

            ' tableName指定で楽観的ロックチェック有効化
            If Not _parentForm.LockService.UpdateData(headerSql, headerParams, "ORDER_HEADERS") Then
                LoadData()  ' 競合時は再読み込み
                Return
            End If

            ' Detail更新（悲観的ロック済み）
            Dim detailSql As String = "UPDATE ORDER_DETAILS SET QUANTITY = :qty WHERE ORDER_ID = :orderId AND LINE_NO = :lineNo"
            Dim detailParams As New Dictionary(Of String, Object) From {
                {"qty", 10},
                {"orderId", _parentForm.RecordId},
                {"lineNo", 1}
            }
            
            _parentForm.LockService.UpdateData(detailSql, detailParams)
            
            ' コミット
            _parentForm.LockService.Commit()
            MessageBox.Show("保存しました。", "完了", MessageBoxButtons.OK, MessageBoxIcon.Information)
            
        Catch ex As Exception
            MessageBox.Show($"保存エラー: {ex.Message}", "エラー", MessageBoxButtons.OK, MessageBoxIcon.Error)
            _parentForm.LockService.ReleaseLock()
        End Try
    End Sub
End Class
```

## 4. DB設定

```sql
-- バージョン管理カラム追加
ALTER TABLE ORDER_HEADERS ADD UPDATE_VERSION NUMBER DEFAULT 0 NOT NULL;

-- インデックス作成（推奨）
CREATE INDEX IDX_ORDER_HEADERS_VER ON ORDER_HEADERS(ORDER_ID, UPDATE_VERSION);
```

## ポイント

| 項目 | 悲観的ロック | 楽観的ロック |
|------|-------------|-------------|
| **対象** | Detail（影響範囲小） | Header（影響範囲大） |
| **ロック方法** | SELECT FOR UPDATE | バージョンチェック |
| **ロックタイミング** | ロックボタン押下時 | 更新時 |
| **競合検出** | ロック取得時に即座に検出 | 更新時に検出 |
| **他ユーザーへの影響** | ロック中は待機 | 影響なし |

この設計により、**ヘッダの排他影響を最小化**しつつ、**Detailの確実なロック**が実現できます。