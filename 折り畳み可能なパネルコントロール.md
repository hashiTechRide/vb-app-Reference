# はじめに
## 開発環境
- 開発対象: `.NET Framework4.8`
- 開発言語: `VB.NET`


## 1. 折りたたみパネルコントロール

```vb
Imports System.ComponentModel
Imports System.Drawing
Imports System.Drawing.Drawing2D
Imports System.Windows.Forms

<Designer(GetType(CollapsiblePanelDesigner))>
Public Class CollapsiblePanel
    Inherits Panel
    
    Private _headerPanel As Panel
    Private _contentPanel As Panel
    Private _headerLabel As Label
    Private _expandButton As Label
    
    Private _headerText As String = "ヘッダー"
    Private _headerHeight As Integer = 40
    Private _isExpanded As Boolean = True
    Private _animationSpeed As Integer = 10
    Private _contentHeight As Integer = 200
    Private _headerBackColor As Color = Color.FromArgb(240, 240, 240)
    Private _headerForeColor As Color = Color.Black
    
    Private _isAnimating As Boolean = False
    Private _animationTimer As Timer
    Private _targetHeight As Integer
    
    Public Sub New()
        MyBase.New()
        InitializeComponent()
    End Sub
    
    Private Sub InitializeComponent()
        Me.SuspendLayout()
        
        ' ヘッダーパネルの初期化
        _headerPanel = New Panel()
        _headerPanel.Dock = DockStyle.Top
        _headerPanel.Height = _headerHeight
        _headerPanel.BackColor = _headerBackColor
        _headerPanel.Cursor = Cursors.Hand
        AddHandler _headerPanel.Click, AddressOf Header_Click
        AddHandler _headerPanel.Paint, AddressOf HeaderPanel_Paint
        
        ' ヘッダーラベル
        _headerLabel = New Label()
        _headerLabel.Text = _headerText
        _headerLabel.AutoSize = False
        _headerLabel.Dock = DockStyle.Fill
        _headerLabel.TextAlign = ContentAlignment.MiddleLeft
        _headerLabel.Padding = New Padding(10, 0, 0, 0)
        _headerLabel.ForeColor = _headerForeColor
        _headerLabel.Cursor = Cursors.Hand
        AddHandler _headerLabel.Click, AddressOf Header_Click
        
        ' 展開/折りたたみボタン
        _expandButton = New Label()
        _expandButton.Text = "▼"
        _expandButton.AutoSize = False
        _expandButton.Dock = DockStyle.Right
        _expandButton.Width = 40
        _expandButton.TextAlign = ContentAlignment.MiddleCenter
        _expandButton.ForeColor = _headerForeColor
        _expandButton.Cursor = Cursors.Hand
        AddHandler _expandButton.Click, AddressOf Header_Click
        
        _headerPanel.Controls.Add(_headerLabel)
        _headerPanel.Controls.Add(_expandButton)
        
        ' コンテンツパネルの初期化
        _contentPanel = New Panel()
        _contentPanel.Dock = DockStyle.Fill
        _contentPanel.BackColor = Color.White
        _contentPanel.Padding = New Padding(5)
        
        ' アニメーションタイマー
        _animationTimer = New Timer()
        _animationTimer.Interval = 10
        AddHandler _animationTimer.Tick, AddressOf AnimationTimer_Tick
        
        ' コントロールの追加
        Me.Controls.Add(_contentPanel)
        Me.Controls.Add(_headerPanel)
        
        ' パネル自体の設定
        Me.BorderStyle = BorderStyle.FixedSingle
        Me.Height = _headerHeight + _contentHeight
        
        Me.ResumeLayout(False)
    End Sub
    
    ' ヘッダーに枠線を描画
    Private Sub HeaderPanel_Paint(sender As Object, e As PaintEventArgs)
        Dim rect As New Rectangle(0, _headerPanel.Height - 1, _headerPanel.Width, 1)
        Using pen As New Pen(Color.FromArgb(200, 200, 200))
            e.Graphics.DrawLine(pen, 0, _headerPanel.Height - 1, _headerPanel.Width, _headerPanel.Height - 1)
        End Using
    End Sub
    
    ' プロパティ
    <Category("外観")>
    <Description("ヘッダーに表示するテキスト")>
    Public Property HeaderText As String
        Get
            Return _headerText
        End Get
        Set(value As String)
            _headerText = value
            If _headerLabel IsNot Nothing Then
                _headerLabel.Text = value
            End If
        End Set
    End Property
    
    <Category("外観")>
    <Description("ヘッダーの高さ")>
    <DefaultValue(40)>
    Public Property HeaderHeight As Integer
        Get
            Return _headerHeight
        End Get
        Set(value As Integer)
            _headerHeight = value
            If _headerPanel IsNot Nothing Then
                _headerPanel.Height = value
            End If
        End Set
    End Property
    
    <Category("外観")>
    <Description("ヘッダーの背景色")>
    Public Property HeaderBackColor As Color
        Get
            Return _headerBackColor
        End Get
        Set(value As Color)
            _headerBackColor = value
            If _headerPanel IsNot Nothing Then
                _headerPanel.BackColor = value
            End If
        End Set
    End Property
    
    <Category("外観")>
    <Description("ヘッダーの文字色")>
    Public Property HeaderForeColor As Color
        Get
            Return _headerForeColor
        End Get
        Set(value As Color)
            _headerForeColor = value
            If _headerLabel IsNot Nothing Then
                _headerLabel.ForeColor = value
            End If
            If _expandButton IsNot Nothing Then
                _expandButton.ForeColor = value
            End If
        End Set
    End Property
    
    <Category("動作")>
    <Description("パネルが展開されているかどうか")>
    <DefaultValue(True)>
    Public Property IsExpanded As Boolean
        Get
            Return _isExpanded
        End Get
        Set(value As Boolean)
            If _isExpanded <> value Then
                _isExpanded = value
                TogglePanel(True) ' アニメーション有効
            End If
        End Set
    End Property
    
    <Category("動作")>
    <Description("アニメーションの速度（ピクセル/フレーム）")>
    <DefaultValue(10)>
    Public Property AnimationSpeed As Integer
        Get
            Return _animationSpeed
        End Get
        Set(value As Integer)
            _animationSpeed = Math.Max(1, value)
        End Set
    End Property
    
    <Category("外観")>
    <Description("コンテンツ部分の高さ")>
    <DefaultValue(200)>
    Public Property ContentHeight As Integer
        Get
            Return _contentHeight
        End Get
        Set(value As Integer)
            _contentHeight = value
            If _isExpanded AndAlso Not _isAnimating Then
                Me.Height = _headerHeight + _contentHeight
            End If
        End Set
    End Property
    
    <Browsable(False)>
    <DesignerSerializationVisibility(DesignerSerializationVisibility.Content)>
    Public ReadOnly Property ContentPanel As Panel
        Get
            Return _contentPanel
        End Get
    End Property
    
    ' ヘッダークリック時の処理
    Private Sub Header_Click(sender As Object, e As EventArgs)
        Toggle()
    End Sub
    
    ' トグル（展開/折りたたみ）
    Public Sub Toggle()
        _isExpanded = Not _isExpanded
        TogglePanel(True)
    End Sub
    
    Private Sub TogglePanel(animate As Boolean)
        If animate Then
            ' アニメーション開始
            _targetHeight = If(_isExpanded, _headerHeight + _contentHeight, _headerHeight)
            _isAnimating = True
            _animationTimer.Start()
        Else
            ' 即座に変更
            Me.Height = If(_isExpanded, _headerHeight + _contentHeight, _headerHeight)
            _contentPanel.Visible = _isExpanded
        End If
        
        ' ボタンアイコンの更新
        _expandButton.Text = If(_isExpanded, "▼", "▶")
        
        ' イベント発火
        OnExpandedChanged(EventArgs.Empty)
    End Sub
    
    ' アニメーションタイマー
    Private Sub AnimationTimer_Tick(sender As Object, e As EventArgs)
        Dim currentHeight = Me.Height
        Dim diff = _targetHeight - currentHeight
        
        If Math.Abs(diff) <= _animationSpeed Then
            ' アニメーション完了
            Me.Height = _targetHeight
            _contentPanel.Visible = _isExpanded
            _isAnimating = False
            _animationTimer.Stop()
            
            ' 親コントロールのレイアウトを更新して下のコントロールを移動
            If Me.Parent IsNot Nothing Then
                Me.Parent.PerformLayout()
            End If
        Else
            ' アニメーション継続
            Dim step = Math.Sign(diff) * _animationSpeed
            Me.Height += step
            
            ' 親コントロールのレイアウトを更新
            If Me.Parent IsNot Nothing Then
                Me.Parent.PerformLayout()
            End If
        End If
    End Sub
    
    ' イベント
    Public Event ExpandedChanged As EventHandler
    
    Protected Overridable Sub OnExpandedChanged(e As EventArgs)
        RaiseEvent ExpandedChanged(Me, e)
    End Sub

    Protected Overrides Sub OnResize(e As EventArgs)
        MyBase.OnResize(e)
    
        ' デザイナー上でのサイズ変更をContentHeightに反映
        If _contentPanel IsNot Nothing AndAlso _isExpanded AndAlso Not _isAnimating Then
            Dim newContentHeight = Me.Height - _headerHeight
            If newContentHeight > 0 Then
                _contentHeight = newContentHeight
            End If
        End If
    End Sub
    
    Protected Overrides Sub Dispose(disposing As Boolean)
        If disposing Then
            If _animationTimer IsNot Nothing Then
                _animationTimer.Stop()
                _animationTimer.Dispose()
            End If
        End If
        MyBase.Dispose(disposing)
    End Sub
End Class
```

## 2. カスタムデザイナー

```vb
Imports System.ComponentModel
Imports System.ComponentModel.Design
Imports System.Windows.Forms.Design

Public Class CollapsiblePanelDesigner
    Inherits ParentControlDesigner
    
    Public Overrides Sub Initialize(component As IComponent)
        MyBase.Initialize(component)
        
        ' デザイン時にコンテンツパネルを選択可能にする
        Dim panel = CType(component, CollapsiblePanel)
        If panel IsNot Nothing Then
            EnableDesignMode(panel.ContentPanel, "ContentPanel")
        End If
    End Sub
    
    Public Overrides ReadOnly Property AssociatedComponents As System.Collections.ICollection
        Get
            Dim panel = CType(Component, CollapsiblePanel)
            If panel IsNot Nothing Then
                Return panel.ContentPanel.Controls
            End If
            Return MyBase.AssociatedComponents
        End Get
    End Property
    
    Protected Overrides Function GetHitTest(point As Point) As Boolean
        ' ヘッダー部分のクリックをデザイナーに伝える
        Dim panel = CType(Component, CollapsiblePanel)
        If panel IsNot Nothing Then
            Dim headerRect As New Rectangle(0, 0, panel.Width, panel.HeaderHeight)
            If headerRect.Contains(point) Then
                Return True
            End If
        End If
        Return MyBase.GetHitTest(point)
    End Function
    
    Public Overrides ReadOnly Property ActionLists As DesignerActionListCollection
        Get
            Dim actionLists As New DesignerActionListCollection()
            actionLists.Add(New CollapsiblePanelActionList(Me.Component))
            Return actionLists
        End Get
    End Property
    
    ' デザイン時にコンテンツパネルへコントロールを追加できるようにする
    Protected Overrides ReadOnly Property InternalControlDesigner(index As Integer) As ControlDesigner
        Get
            Dim panel = CType(Component, CollapsiblePanel)
            If panel IsNot Nothing AndAlso index = 0 Then
                Return CType(GetDesigner(panel.ContentPanel), ControlDesigner)
            End If
            Return MyBase.InternalControlDesigner(index)
        End Get
    End Property
    
    Public Overrides ReadOnly Property InternalControlDesignerCount As Integer
        Get
            Return 1
        End Get
    End Property
End Class
```

## 3. スマートタグアクションリスト

```vb
Imports System.ComponentModel
Imports System.ComponentModel.Design

Public Class CollapsiblePanelActionList
    Inherits DesignerActionList
    
    Private _panel As CollapsiblePanel
    
    Public Sub New(component As IComponent)
        MyBase.New(component)
        _panel = CType(component, CollapsiblePanel)
    End Sub
    
    Public Overrides Function GetSortedActionItems() As DesignerActionItemCollection
        Dim items As New DesignerActionItemCollection()
        
        items.Add(New DesignerActionHeaderItem("外観"))
        items.Add(New DesignerActionPropertyItem("HeaderText", "ヘッダーテキスト", "外観"))
        items.Add(New DesignerActionPropertyItem("HeaderHeight", "ヘッダーの高さ", "外観"))
        items.Add(New DesignerActionPropertyItem("ContentHeight", "コンテンツの高さ", "外観"))
        
        items.Add(New DesignerActionHeaderItem("動作"))
        items.Add(New DesignerActionPropertyItem("IsExpanded", "展開状態", "動作"))
        items.Add(New DesignerActionMethodItem(Me, "TogglePanel", "展開/折りたたみ", "動作"))
        
        Return items
    End Function
    
    Public Property HeaderText As String
        Get
            Return _panel.HeaderText
        End Get
        Set(value As String)
            GetPropertyByName("HeaderText").SetValue(_panel, value)
        End Set
    End Property
    
    Public Property HeaderHeight As Integer
        Get
            Return _panel.HeaderHeight
        End Get
        Set(value As Integer)
            GetPropertyByName("HeaderHeight").SetValue(_panel, value)
        End Set
    End Property
    
    Public Property ContentHeight As Integer
        Get
            Return _panel.ContentHeight
        End Get
        Set(value As Integer)
            GetPropertyByName("ContentHeight").SetValue(_panel, value)
        End Set
    End Property
    
    Public Property IsExpanded As Boolean
        Get
            Return _panel.IsExpanded
        End Get
        Set(value As Boolean)
            GetPropertyByName("IsExpanded").SetValue(_panel, value)
        End Set
    End Property
    
    Public Sub TogglePanel()
        _panel.Toggle()
    End Sub
    
    Private Function GetPropertyByName(propName As String) As PropertyDescriptor
        Return TypeDescriptor.GetProperties(_panel)(propName)
    End Function
End Class
```

## 4. 使い方

### フォームでの配置

```vb
Public Class Form1
    Private Sub Form1_Load(sender As Object, e As EventArgs) Handles MyBase.Load
        ' CollapsiblePanelを追加
        Dim panel1 As New CollapsiblePanel()
        panel1.Location = New Point(10, 10)
        panel1.Width = 400
        panel1.HeaderText = "セクション1"
        panel1.Dock = DockStyle.Top
        Me.Controls.Add(panel1)
        
        ' コンテンツパネルにコントロールを追加
        Dim label As New Label()
        label.Text = "これはコンテンツです"
        label.Location = New Point(10, 10)
        panel1.ContentPanel.Controls.Add(label)
        
        ' 2つ目のパネル
        Dim panel2 As New CollapsiblePanel()
        panel2.Location = New Point(10, panel1.Bottom + 10)
        panel2.Width = 400
        panel2.HeaderText = "セクション2"
        panel2.Dock = DockStyle.Top
        Me.Controls.Add(panel2)
        
        ' 下のパネルを上に配置（Dock順序の調整）
        panel2.BringToFront()
    End Sub
End Class
```

### デザイナーでの使用

1. ツールボックスから`CollapsiblePanel`をフォームにドラッグ
2. `Dock`プロパティを`Top`に設定
3. 複数配置する場合は、上から順に配置
4. コンテンツパネル内をクリックして、内部にコントロールを配置

このコントロールは、折りたたむと下のコントロールが自動的に上に移動します。`Dock = DockStyle.Top`を使用することで、複数のパネルをスタックして管理できます。

# おわりに
カスタムデザイナーの勉強として今回は折り畳み可能なパネルコントロールを作成してみました。
デザイナー上での子コントロール操作方法を学ぶことが出来ました。他にも流用できそうなので、他の属性も勉強していこうと思います。
