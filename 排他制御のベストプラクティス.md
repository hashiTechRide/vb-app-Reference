# DB排他制御のクラス設計ベストプラクティス

## 1. 基本的な設計原則

### 単一責任の原則に基づく階層構造

```
┌─────────────────────────────────────┐
│  Presentation Layer (UI)            │  ← フォーム、コントロール
├─────────────────────────────────────┤
│  Application Layer                  │  ← ビジネスロジック、ユースケース
├─────────────────────────────────────┤
│  Domain Layer                       │  ← エンティティ、ドメインロジック
├─────────────────────────────────────┤
│  Infrastructure Layer               │  ← DB接続、ロック管理
└─────────────────────────────────────┘
```

## 2. 推奨クラス構成

### 2-1. データモデル層

```vb.net
''' <summary>
''' ロックタイプ
''' </summary>
Public Enum LockType
    None            ' ロックなし
    Pessimistic     ' 悲観的ロック
    Optimistic      ' 楽観的ロック
End Enum

''' <summary>
''' ロック戦略インターフェース
''' </summary>
Public Interface ILockStrategy
    Function AcquireLock(connection As IDbConnection, transaction As IDbTransaction) As Boolean
    Function ValidateLock(connection As IDbConnection, transaction As IDbTransaction) As Boolean
    Sub ReleaseLock()
End Interface

''' <summary>
''' ロック対象エンティティ
''' </summary>
Public Class LockableEntity
    Public Property TableName As String
    Public Property PrimaryKey As Dictionary(Of String, Object)
    Public Property LockType As LockType
    Public Property Version As Object  ' 楽観的ロック用
End Class
```

### 2-2. ロック戦略パターン実装

```vb.net
''' <summary>
''' 悲観的ロック戦略
''' </summary>
Public Class PessimisticLockStrategy
    Implements ILockStrategy
    
    Private _entity As LockableEntity
    Private _command As IDbCommand
    
    Public Sub New(entity As LockableEntity)
        _entity = entity
    End Sub
    
    Public Function AcquireLock(connection As IDbConnection, transaction As IDbTransaction) As Boolean Implements ILockStrategy.AcquireLock
        Try
            Dim whereClause As String = BuildWhereClause(_entity.PrimaryKey)
            Dim sql As String = $"SELECT * FROM {_entity.TableName} WHERE {whereClause} FOR UPDATE NOWAIT"
            
            _command = connection.CreateCommand()
            _command.Transaction = transaction
            _command.CommandText = sql
            
            AddParameters(_command, _entity.PrimaryKey)
            
            Using reader As IDataReader = _command.ExecuteReader()
                Return reader.Read()
            End Using
            
        Catch ex As Exception
            ' ORA-00054など
            Return False
        End Try
    End Function
    
    Public Function ValidateLock(connection As IDbConnection, transaction As IDbTransaction) As Boolean Implements ILockStrategy.ValidateLock
        ' 悲観的ロックは取得時に検証済み
        Return True
    End Function
    
    Public Sub ReleaseLock() Implements ILockStrategy.ReleaseLock
        _command?.Dispose()
    End Sub
    
    Private Function BuildWhereClause(keys As Dictionary(Of String, Object)) As String
        Return String.Join(" AND ", keys.Keys.Select(Function(k) $"{k} = :{k}"))
    End Function
    
    Private Sub AddParameters(cmd As IDbCommand, parameters As Dictionary(Of String, Object))
        For Each kvp In parameters
            Dim param As IDbDataParameter = cmd.CreateParameter()
            param.ParameterName = kvp.Key
            param.Value = kvp.Value
            cmd.Parameters.Add(param)
        Next
    End Sub
End Class

''' <summary>
''' 楽観的ロック戦略
''' </summary>
Public Class OptimisticLockStrategy
    Implements ILockStrategy
    
    Private _entity As LockableEntity
    Private _originalVersion As Object
    Private Const VERSION_COLUMN As String = "UPDATE_VERSION"
    
    Public Sub New(entity As LockableEntity)
        _entity = entity
    End Sub
    
    Public Function AcquireLock(connection As IDbConnection, transaction As IDbTransaction) As Boolean Implements ILockStrategy.AcquireLock
        Try
            Dim whereClause As String = BuildWhereClause(_entity.PrimaryKey)
            Dim sql As String = $"SELECT {VERSION_COLUMN} FROM {_entity.TableName} WHERE {whereClause}"
            
            Using cmd As IDbCommand = connection.CreateCommand()
                cmd.Transaction = transaction
                cmd.CommandText = sql
                AddParameters(cmd, _entity.PrimaryKey)
                
                _originalVersion = cmd.ExecuteScalar()
                Return _originalVersion IsNot Nothing
            End Using
            
        Catch ex As Exception
            Return False
        End Try
    End Function
    
    Public Function ValidateLock(connection As IDbConnection, transaction As IDbTransaction) As Boolean Implements ILockStrategy.ValidateLock
        Try
            Dim whereClause As String = BuildWhereClause(_entity.PrimaryKey)
            Dim sql As String = $"SELECT {VERSION_COLUMN} FROM {_entity.TableName} WHERE {whereClause}"
            
            Using cmd As IDbCommand = connection.CreateCommand()
                cmd.Transaction = transaction
                cmd.CommandText = sql
                AddParameters(cmd, _entity.PrimaryKey)
                
                Dim currentVersion As Object = cmd.ExecuteScalar()
                Return currentVersion IsNot Nothing AndAlso currentVersion.Equals(_originalVersion)
            End Using
            
        Catch ex As Exception
            Return False
        End Try
    End Function
    
    Public Sub ReleaseLock() Implements ILockStrategy.ReleaseLock
        ' 楽観的ロックは解放不要
    End Sub
    
    Private Function BuildWhereClause(keys As Dictionary(Of String, Object)) As String
        Return String.Join(" AND ", keys.Keys.Select(Function(k) $"{k} = :{k}"))
    End Function
    
    Private Sub AddParameters(cmd As IDbCommand, parameters As Dictionary(Of String, Object))
        For Each kvp In parameters
            Dim param As IDbDataParameter = cmd.CreateParameter()
            param.ParameterName = kvp.Key
            param.Value = kvp.Value
            cmd.Parameters.Add(param)
        Next
    End Sub
End Class
```

### 2-3. ロックマネージャー（ファサードパターン）

```vb.net
''' <summary>
''' ロック管理の統合インターフェース
''' </summary>
Public Interface ILockManager
    Function AcquireLocks(entities As List(Of LockableEntity)) As Boolean
    Function ValidateLocks() As Boolean
    Sub ReleaseLocks()
    Function ExecuteInTransaction(Of T)(func As Func(Of T)) As T
    Sub Commit()
    Sub Rollback()
End Interface

''' <summary>
''' ロックマネージャー実装
''' </summary>
Public Class LockManager
    Implements ILockManager
    Implements IDisposable
    
    Private _connection As IDbConnection
    Private _transaction As IDbTransaction
    Private _strategies As New List(Of ILockStrategy)
    Private _isLocked As Boolean = False
    
    Public Sub New(connection As IDbConnection)
        _connection = connection
    End Sub
    
    Public Function AcquireLocks(entities As List(Of LockableEntity)) As Boolean Implements ILockManager.AcquireLocks
        Try
            If _connection.State <> ConnectionState.Open Then
                _connection.Open()
            End If
            
            _transaction = _connection.BeginTransaction()
            _strategies.Clear()
            
            For Each entity In entities
                Dim strategy As ILockStrategy = CreateStrategy(entity)
                
                If Not strategy.AcquireLock(_connection, _transaction) Then
                    ReleaseLocks()
                    Return False
                End If
                
                _strategies.Add(strategy)
            Next
            
            _isLocked = True
            Return True
            
        Catch ex As Exception
            ReleaseLocks()
            Throw New LockException("ロック取得に失敗しました。", ex)
        End Try
    End Function
    
    Public Function ValidateLocks() As Boolean Implements ILockManager.ValidateLocks
        For Each strategy In _strategies
            If Not strategy.ValidateLock(_connection, _transaction) Then
                Return False
            End If
        Next
        Return True
    End Function
    
    Public Sub ReleaseLocks() Implements ILockManager.ReleaseLocks
        Try
            If _isLocked AndAlso _transaction IsNot Nothing Then
                _transaction.Rollback()
            End If
        Finally
            For Each strategy In _strategies
                strategy.ReleaseLock()
            Next
            _strategies.Clear()
            
            _transaction?.Dispose()
            _transaction = Nothing
            _isLocked = False
        End Try
    End Sub
    
    Public Function ExecuteInTransaction(Of T)(func As Func(Of T)) As T Implements ILockManager.ExecuteInTransaction
        If Not _isLocked Then
            Throw New InvalidOperationException("ロックが取得されていません。")
        End If
        
        Return func()
    End Function
    
    Public Sub Commit() Implements ILockManager.Commit
        If _isLocked AndAlso _transaction IsNot Nothing Then
            _transaction.Commit()
            _isLocked = False
        End If
    End Sub
    
    Public Sub Rollback() Implements ILockManager.Rollback
        ReleaseLocks()
    End Sub
    
    Private Function CreateStrategy(entity As LockableEntity) As ILockStrategy
        Select Case entity.LockType
            Case LockType.Pessimistic
                Return New PessimisticLockStrategy(entity)
            Case LockType.Optimistic
                Return New OptimisticLockStrategy(entity)
            Case Else
                Throw New ArgumentException($"未対応のロックタイプ: {entity.LockType}")
        End Select
    End Function
    
    Public Sub Dispose() Implements IDisposable.Dispose
        ReleaseLocks()
        If _connection IsNot Nothing AndAlso _connection.State = ConnectionState.Open Then
            _connection.Close()
        End If
    End Sub
End Class

''' <summary>
''' カスタム例外
''' </summary>
Public Class LockException
    Inherits Exception
    
    Public Sub New(message As String, innerException As Exception)
        MyBase.New(message, innerException)
    End Sub
End Class
```

### 2-4. リポジトリパターン

```vb.net
''' <summary>
''' リポジトリ基底クラス
''' </summary>
Public MustInherit Class RepositoryBase(Of T)
    Protected _lockManager As ILockManager
    
    Public Sub New(lockManager As ILockManager)
        _lockManager = lockManager
    End Sub
    
    Public MustOverride Function GetById(id As Object) As T
    Public MustOverride Function Update(entity As T) As Boolean
    Public MustOverride Function GetLockableEntities(id As Object) As List(Of LockableEntity)
End Class

''' <summary>
''' 注文リポジトリ
''' </summary>
Public Class OrderRepository
    Inherits RepositoryBase(Of Order)
    
    Public Sub New(lockManager As ILockManager)
        MyBase.New(lockManager)
    End Sub
    
    Public Overrides Function GetById(id As Object) As Order
        ' データ取得ロジック
        Return New Order()
    End Function
    
    Public Overrides Function Update(entity As Order) As Boolean
        Return _lockManager.ExecuteInTransaction(Function()
            ' 楽観的ロック検証
            If Not _lockManager.ValidateLocks() Then
                Return False
            End If
            
            ' 更新処理
            ' ...
            
            Return True
        End Function)
    End Function
    
    Public Overrides Function GetLockableEntities(id As Object) As List(Of LockableEntity)
        Dim entities As New List(Of LockableEntity)
        
        ' ヘッダ（楽観的ロック）
        entities.Add(New LockableEntity With {
            .TableName = "ORDER_HEADERS",
            .PrimaryKey = New Dictionary(Of String, Object) From {{"ORDER_ID", id}},
            .LockType = LockType.Optimistic
        })
        
        ' 明細（悲観的ロック）
        entities.Add(New LockableEntity With {
            .TableName = "ORDER_DETAILS",
            .PrimaryKey = New Dictionary(Of String, Object) From {{"ORDER_ID", id}},
            .LockType = LockType.Pessimistic
        })
        
        Return entities
    End Function
End Class
```

### 2-5. Unit of Work パターン

```vb.net
''' <summary>
''' Unit of Work インターフェース
''' </summary>
Public Interface IUnitOfWork
    Inherits IDisposable
    
    ReadOnly Property LockManager As ILockManager
    Function GetRepository(Of T As RepositoryBase(Of Object))() As T
    Sub Commit()
    Sub Rollback()
End Interface

''' <summary>
''' Unit of Work 実装
''' </summary>
Public Class UnitOfWork
    Implements IUnitOfWork
    
    Private _lockManager As ILockManager
    Private _repositories As New Dictionary(Of Type, Object)
    
    Public Sub New(connectionString As String)
        Dim connection As IDbConnection = New OracleConnection(connectionString)
        _lockManager = New LockManager(connection)
    End Sub
    
    Public ReadOnly Property LockManager As ILockManager Implements IUnitOfWork.LockManager
        Get
            Return _lockManager
        End Get
    End Property
    
    Public Function GetRepository(Of T As RepositoryBase(Of Object))() As T Implements IUnitOfWork.GetRepository
        Dim type As Type = GetType(T)
        
        If Not _repositories.ContainsKey(type) Then
            Dim repository As T = CType(Activator.CreateInstance(type, _lockManager), T)
            _repositories.Add(type, repository)
        End If
        
        Return CType(_repositories(type), T)
    End Function
    
    Public Sub Commit() Implements IUnitOfWork.Commit
        _lockManager.Commit()
    End Sub
    
    Public Sub Rollback() Implements IUnitOfWork.Rollback
        _lockManager.Rollback()
    End Sub
    
    Public Sub Dispose() Implements IDisposable.Dispose
        _lockManager?.Dispose()
    End Sub
End Class
```

### 2-6. サービス層（ビジネスロジック）

```vb.net
''' <summary>
''' 注文サービス
''' </summary>
Public Class OrderService
    Private _connectionString As String
    
    Public Sub New(connectionString As String)
        _connectionString = connectionString
    End Sub
    
    ''' <summary>
    ''' 注文更新（ロック制御込み）
    ''' </summary>
    Public Function UpdateOrder(orderId As Integer, updates As OrderUpdateDto) As ServiceResult
        Using uow As New UnitOfWork(_connectionString)
            Try
                ' リポジトリ取得
                Dim orderRepo As OrderRepository = uow.GetRepository(Of OrderRepository)()
                
                ' ロック対象取得
                Dim lockEntities As List(Of LockableEntity) = orderRepo.GetLockableEntities(orderId)
                
                ' ロック取得
                If Not uow.LockManager.AcquireLocks(lockEntities) Then
                    Return ServiceResult.Failure("ロックの取得に失敗しました。")
                End If
                
                ' データ取得
                Dim order As Order = orderRepo.GetById(orderId)
                
                ' ビジネスロジック
                order.CustomerName = updates.CustomerName
                order.OrderDate = updates.OrderDate
                
                ' 更新
                If Not orderRepo.Update(order) Then
                    Return ServiceResult.Failure("データが他のユーザーによって更新されています。")
                End If
                
                ' コミット
                uow.Commit()
                
                Return ServiceResult.Success()
                
            Catch ex As Exception
                uow.Rollback()
                Return ServiceResult.Failure($"更新エラー: {ex.Message}")
            End Try
        End Using
    End Function
End Class

''' <summary>
''' サービス結果
''' </summary>
Public Class ServiceResult
    Public Property IsSuccess As Boolean
    Public Property Message As String
    
    Public Shared Function Success() As ServiceResult
        Return New ServiceResult With {.IsSuccess = True}
    End Function
    
    Public Shared Function Failure(message As String) As ServiceResult
        Return New ServiceResult With {.IsSuccess = False, .Message = message}
    End Function
End Class

Public Class OrderUpdateDto
    Public Property CustomerName As String
    Public Property OrderDate As Date
End Class
```

### 2-7. プレゼンテーション層での使用

```vb.net
Public Class OrderEditForm
    Private _orderService As OrderService
    Private _orderId As Integer
    
    Public Sub New(orderId As Integer)
        InitializeComponent()
        _orderId = orderId
        _orderService = New OrderService(ConfigurationManager.ConnectionStrings("OracleDB").ConnectionString)
    End Sub
    
    Private Sub btnSave_Click(sender As Object, e As EventArgs) Handles btnSave.Click
        Dim updates As New OrderUpdateDto With {
            .CustomerName = txtCustomerName.Text,
            .OrderDate = dtpOrderDate.Value
        }
        
        Dim result As ServiceResult = _orderService.UpdateOrder(_orderId, updates)
        
        If result.IsSuccess Then
            MessageBox.Show("保存しました。", "完了", MessageBoxButtons.OK, MessageBoxIcon.Information)
        Else
            MessageBox.Show(result.Message, "エラー", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End If
    End Sub
End Class
```

## 3. 設計パターンのまとめ

| パターン | 役割 | メリット |
|---------|------|---------|
| **Strategy** | ロック方式の切替 | ロック方式の追加が容易 |
| **Facade** | 複雑なロック処理を隠蔽 | 使いやすいインターフェース |
| **Repository** | データアクセスの抽象化 | ビジネスロジックとDB分離 |
| **Unit of Work** | トランザクション管理 | 整合性の保証 |
| **Factory** | ロック戦略の生成 | 生成ロジックの集約 |

## 4. ベストプラクティス

### ✅ DO（推奨）

1. **責任の分離**: 各クラスは単一の責任を持つ
2. **インターフェース指向**: 実装ではなくインターフェースに依存
3. **例外処理**: カスタム例外で分かりやすいエラー処理
4. **リソース管理**: Using文やIDisposableで確実に解放
5. **テスタビリティ**: モック化可能な設計

### ❌ DON'T（非推奨）

1. **God Class**: 1つのクラスに全てを詰め込む
2. **直接SQL**: プレゼンテーション層でSQL実行
3. **グローバル状態**: 静的変数でロック状態管理
4. **例外の握りつぶし**: エラーを無視
5. **リソースリーク**: 接続やトランザクションの解放忘れ

この設計により、**保守性・拡張性・テスタビリティ**に優れた排他制御が実現できます。