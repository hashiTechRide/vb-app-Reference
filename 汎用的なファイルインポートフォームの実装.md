## はじめに

複数のアプリケーションで使い回せる、汎用的なファイルインポートフォームを実装します。

ドラッグ＆ドロップやファイル選択ダイアログに対応し、拡張子やファイルサイズの検証、重複チェックなど、実用的な機能を備えた設計を解説します。

### 開発環境
- 開発対象: .NET Framework 4.8
- 開発言語: VB.NET

### 実装する機能

| 機能 | 説明 |
|------|------|
| **ドラッグ＆ドロップ** | ファイルをドラッグしてインポート |
| **ファイル選択ダイアログ** | ボタンからファイルを選択 |
| **ファイル検証** | 拡張子、サイズ、カスタム検証 |
| **重複チェック** | 同じファイルの追加を防止 |
| **エラー表示** | 無効なファイルを視覚的に表示 |
| **選択削除** | 不要なファイルを削除 |
| **ファイル情報表示** | サイズ、更新日時などを表示 |

## 1. ファイル情報クラス

まず、ファイル情報を保持するクラスを作成します。

```vb
Imports System.IO

Public Class ImportFileInfo
    ''' <summary>ファイルのフルパス</summary>
    Public Property FilePath As String
    
    ''' <summary>ファイル名</summary>
    Public Property FileName As String
        Get
            Return If(String.IsNullOrEmpty(FilePath), String.Empty, Path.GetFileName(FilePath))
        End Get
        Set(value As String)
            ' 読み取り専用
        End Set
    End Property
    
    ''' <summary>拡張子</summary>
    Public Property Extension As String
        Get
            Return If(String.IsNullOrEmpty(FilePath), String.Empty, Path.GetExtension(FilePath))
        End Get
        Set(value As String)
            ' 読み取り専用
        End Set
    End Property
    
    ''' <summary>ファイルサイズ（バイト）</summary>
    Public Property FileSize As Long
    
    ''' <summary>ファイルサイズ（表示用）</summary>
    Public ReadOnly Property FileSizeDisplay As String
        Get
            If FileSize < 1024 Then
                Return $"{FileSize} B"
            ElseIf FileSize < 1024 * 1024 Then
                Return $"{FileSize / 1024:F2} KB"
            ElseIf FileSize < 1024 * 1024 * 1024 Then
                Return $"{FileSize / 1024 / 1024:F2} MB"
            Else
                Return $"{FileSize / 1024 / 1024 / 1024:F2} GB"
            End If
        End Get
    End Property
    
    ''' <summary>最終更新日時</summary>
    Public Property LastModified As DateTime
    
    ''' <summary>検証結果</summary>
    Public Property IsValid As Boolean
    
    ''' <summary>エラーメッセージ</summary>
    Public Property ErrorMessage As String
    
    ''' <summary>カスタムデータ（呼び出し側で自由に使用）</summary>
    Public Property Tag As Object
    
    Public Sub New(filePath As String)
        Me.FilePath = filePath
        
        If File.Exists(filePath) Then
            Dim fileInfo As New FileInfo(filePath)
            Me.FileSize = fileInfo.Length
            Me.LastModified = fileInfo.LastWriteTime
            Me.IsValid = True
        Else
            Me.IsValid = False
            Me.ErrorMessage = "ファイルが存在しません"
        End If
    End Sub
End Class
```

### ポイント
- `FileName`と`Extension`は自動計算プロパティ
- `FileSizeDisplay`で人間が読みやすい形式に変換
- `Tag`プロパティで呼び出し側が自由にデータを格納可能

## 2. インポート設定クラス

ファイルインポートの動作をカスタマイズするための設定クラスです。

```vb
Public Class FileImportSettings
    ''' <summary>許可する拡張子（null = すべて許可）</summary>
    Public Property AllowedExtensions As String()
    
    ''' <summary>最大ファイルサイズ（バイト、0 = 制限なし）</summary>
    Public Property MaxFileSize As Long = 0
    
    ''' <summary>最大ファイル数（0 = 制限なし）</summary>
    Public Property MaxFileCount As Integer = 0
    
    ''' <summary>重複ファイルを許可するか</summary>
    Public Property AllowDuplicates As Boolean = False
    
    ''' <summary>サブフォルダを含めるか（フォルダドロップ時）</summary>
    Public Property IncludeSubfolders As Boolean = False
    
    ''' <summary>フォームのタイトル</summary>
    Public Property FormTitle As String = "ファイルインポート"
    
    ''' <summary>説明文</summary>
    Public Property Description As String = "インポートするファイルを選択してください"
    
    ''' <summary>ファイル選択ダイアログのフィルター</summary>
    Public ReadOnly Property FileDialogFilter As String
        Get
            If AllowedExtensions Is Nothing OrElse AllowedExtensions.Length = 0 Then
                Return "すべてのファイル (*.*)|*.*"
            Else
                Dim extensions = String.Join(";", AllowedExtensions.Select(Function(ext) $"*{ext}"))
                Return $"対応ファイル ({extensions})|{extensions}|すべてのファイル (*.*)|*.*"
            End If
        End Get
    End Property
    
    ''' <summary>カスタム検証デリゲート</summary>
    Public Property CustomValidator As Func(Of ImportFileInfo, (IsValid As Boolean, ErrorMessage As String))
End Class
```

### ポイント
- 拡張子、ファイルサイズ、ファイル数の制限を設定可能
- `CustomValidator`で独自の検証ロジックを追加可能
- `FileDialogFilter`は自動生成

## 3. ファイルインポートフォーム

メインとなるファイルインポートフォームの実装です。

### 3-1. フォームの初期化

```vb
Imports System.Windows.Forms
Imports System.IO
Imports System.Linq

Public Class FileImportForm
    Private _settings As FileImportSettings
    Private _fileList As New List(Of ImportFileInfo)
    Private _selectedFiles As List(Of ImportFileInfo)
    
    ' コントロール
    Private lblDescription As Label
    Private dgvFiles As DataGridView
    Private btnSelectFiles As Button
    Private btnRemoveSelected As Button
    Private btnClearAll As Button
    Private btnOK As Button
    Private btnCancel As Button
    Private lblFileCount As Label
    Private pnlDropZone As Panel
    
    ''' <summary>選択されたファイル一覧を取得</summary>
    Public ReadOnly Property SelectedFiles As List(Of ImportFileInfo)
        Get
            Return _selectedFiles
        End Get
    End Property
    
    Public Sub New(settings As FileImportSettings)
        InitializeComponent()
        _settings = If(settings, New FileImportSettings())
        ApplySettings()
    End Sub
    
    Private Sub InitializeComponent()
        Me.Text = "ファイルインポート"
        Me.Size = New Size(800, 600)
        Me.StartPosition = FormStartPosition.CenterParent
        Me.FormBorderStyle = FormBorderStyle.Sizable
        Me.MinimumSize = New Size(600, 400)
        
        ' 説明ラベル
        lblDescription = New Label()
        lblDescription.Text = "インポートするファイルを選択してください"
        lblDescription.Location = New Point(10, 10)
        lblDescription.Size = New Size(760, 20)
        lblDescription.Anchor = AnchorStyles.Top Or AnchorStyles.Left Or AnchorStyles.Right
        Me.Controls.Add(lblDescription)
        
        ' ドロップゾーンパネル
        CreateDropZone()
        
        ' ファイル一覧グリッド
        CreateDataGridView()
        
        ' ファイル数ラベル
        lblFileCount = New Label()
        lblFileCount.Text = "ファイル数: 0"
        lblFileCount.Location = New Point(10, 475)
        lblFileCount.Size = New Size(200, 20)
        lblFileCount.Anchor = AnchorStyles.Bottom Or AnchorStyles.Left
        Me.Controls.Add(lblFileCount)
        
        ' ボタン類
        CreateButtons()
    End Sub
    
    Private Sub CreateDropZone()
        ' ドロップゾーンパネル
        pnlDropZone = New Panel()
        pnlDropZone.Location = New Point(10, 35)
        pnlDropZone.Size = New Size(760, 80)
        pnlDropZone.BorderStyle = BorderStyle.FixedSingle
        pnlDropZone.BackColor = Color.LightBlue
        pnlDropZone.Anchor = AnchorStyles.Top Or AnchorStyles.Left Or AnchorStyles.Right
        pnlDropZone.AllowDrop = True
        
        Dim lblDropZone As New Label()
        lblDropZone.Text = "ここにファイルをドラッグ＆ドロップ" & Environment.NewLine & 
                          "または下の「ファイル選択」ボタンをクリック"
        lblDropZone.Dock = DockStyle.Fill
        lblDropZone.TextAlign = ContentAlignment.MiddleCenter
        lblDropZone.Font = New Font(lblDropZone.Font.FontFamily, 10, FontStyle.Bold)
        lblDropZone.ForeColor = Color.DarkBlue
        pnlDropZone.Controls.Add(lblDropZone)
        
        AddHandler pnlDropZone.DragEnter, AddressOf PnlDropZone_DragEnter
        AddHandler pnlDropZone.DragDrop, AddressOf PnlDropZone_DragDrop
        AddHandler pnlDropZone.DragLeave, AddressOf PnlDropZone_DragLeave
        
        Me.Controls.Add(pnlDropZone)
    End Sub
    
    Private Sub CreateDataGridView()
        dgvFiles = New DataGridView()
        dgvFiles.Location = New Point(10, 120)
        dgvFiles.Size = New Size(760, 350)
        dgvFiles.Anchor = AnchorStyles.Top Or AnchorStyles.Bottom Or AnchorStyles.Left Or AnchorStyles.Right
        dgvFiles.AllowUserToAddRows = False
        dgvFiles.AllowUserToDeleteRows = False
        dgvFiles.ReadOnly = True
        dgvFiles.SelectionMode = DataGridViewSelectionMode.FullRowSelect
        dgvFiles.MultiSelect = True
        dgvFiles.AutoGenerateColumns = False
        
        ' 列を定義
        dgvFiles.Columns.Add(New DataGridViewTextBoxColumn With {
            .Name = "colFileName",
            .HeaderText = "ファイル名",
            .DataPropertyName = "FileName",
            .Width = 250,
            .AutoSizeMode = DataGridViewAutoSizeColumnMode.Fill
        })
        
        dgvFiles.Columns.Add(New DataGridViewTextBoxColumn With {
            .Name = "colExtension",
            .HeaderText = "拡張子",
            .DataPropertyName = "Extension",
            .Width = 80
        })
        
        dgvFiles.Columns.Add(New DataGridViewTextBoxColumn With {
            .Name = "colFileSize",
            .HeaderText = "サイズ",
            .DataPropertyName = "FileSizeDisplay",
            .Width = 100
        })
        
        dgvFiles.Columns.Add(New DataGridViewTextBoxColumn With {
            .Name = "colLastModified",
            .HeaderText = "更新日時",
            .DataPropertyName = "LastModified",
            .Width = 150,
            .DefaultCellStyle = New DataGridViewCellStyle With {.Format = "yyyy/MM/dd HH:mm:ss"}
        })
        
        dgvFiles.Columns.Add(New DataGridViewTextBoxColumn With {
            .Name = "colStatus",
            .HeaderText = "状態",
            .DataPropertyName = "ErrorMessage",
            .Width = 150
        })
        
        dgvFiles.Columns.Add(New DataGridViewTextBoxColumn With {
            .Name = "colFilePath",
            .HeaderText = "パス",
            .DataPropertyName = "FilePath",
            .Width = 300
        })
        
        AddHandler dgvFiles.CellFormatting, AddressOf DgvFiles_CellFormatting
        
        Me.Controls.Add(dgvFiles)
    End Sub
    
    Private Sub CreateButtons()
        ' ファイル選択ボタン
        btnSelectFiles = New Button()
        btnSelectFiles.Text = "ファイル選択..."
        btnSelectFiles.Location = New Point(10, 500)
        btnSelectFiles.Size = New Size(120, 30)
        btnSelectFiles.Anchor = AnchorStyles.Bottom Or AnchorStyles.Left
        AddHandler btnSelectFiles.Click, AddressOf BtnSelectFiles_Click
        Me.Controls.Add(btnSelectFiles)
        
        ' 選択削除ボタン
        btnRemoveSelected = New Button()
        btnRemoveSelected.Text = "選択を削除"
        btnRemoveSelected.Location = New Point(140, 500)
        btnRemoveSelected.Size = New Size(120, 30)
        btnRemoveSelected.Anchor = AnchorStyles.Bottom Or AnchorStyles.Left
        AddHandler btnRemoveSelected.Click, AddressOf BtnRemoveSelected_Click
        Me.Controls.Add(btnRemoveSelected)
        
        ' 全削除ボタン
        btnClearAll = New Button()
        btnClearAll.Text = "すべてクリア"
        btnClearAll.Location = New Point(270, 500)
        btnClearAll.Size = New Size(120, 30)
        btnClearAll.Anchor = AnchorStyles.Bottom Or AnchorStyles.Left
        AddHandler btnClearAll.Click, AddressOf BtnClearAll_Click
        Me.Controls.Add(btnClearAll)
        
        ' OKボタン
        btnOK = New Button()
        btnOK.Text = "OK"
        btnOK.Location = New Point(590, 500)
        btnOK.Size = New Size(90, 30)
        btnOK.Anchor = AnchorStyles.Bottom Or AnchorStyles.Right
        btnOK.DialogResult = DialogResult.OK
        AddHandler btnOK.Click, AddressOf BtnOK_Click
        Me.Controls.Add(btnOK)
        Me.AcceptButton = btnOK
        
        ' キャンセルボタン
        btnCancel = New Button()
        btnCancel.Text = "キャンセル"
        btnCancel.Location = New Point(690, 500)
        btnCancel.Size = New Size(90, 30)
        btnCancel.Anchor = AnchorStyles.Bottom Or AnchorStyles.Right
        btnCancel.DialogResult = DialogResult.Cancel
        Me.Controls.Add(btnCancel)
        Me.CancelButton = btnCancel
    End Sub
    
    Private Sub ApplySettings()
        If _settings IsNot Nothing Then
            Me.Text = _settings.FormTitle
            lblDescription.Text = _settings.Description
        End If
    End Sub
End Class
```

### 3-2. ドラッグ＆ドロップの実装

```vb
' ドラッグエンター
Private Sub PnlDropZone_DragEnter(sender As Object, e As DragEventArgs)
    If e.Data.GetDataPresent(DataFormats.FileDrop) Then
        e.Effect = DragDropEffects.Copy
        pnlDropZone.BackColor = Color.LightGreen ' ドロップ可能を視覚的に表示
    Else
        e.Effect = DragDropEffects.None
    End If
End Sub

' ドラッグリーブ
Private Sub PnlDropZone_DragLeave(sender As Object, e As EventArgs)
    pnlDropZone.BackColor = Color.LightBlue ' 元の色に戻す
End Sub

' ドロップ
Private Sub PnlDropZone_DragDrop(sender As Object, e As DragEventArgs)
    pnlDropZone.BackColor = Color.LightBlue
    
    If e.Data.GetDataPresent(DataFormats.FileDrop) Then
        Dim files As String() = CType(e.Data.GetData(DataFormats.FileDrop), String())
        AddFiles(files)
    End If
End Sub
```

### 3-3. ファイル選択ダイアログ

```vb
' ファイル選択ボタン
Private Sub BtnSelectFiles_Click(sender As Object, e As EventArgs)
    Using ofd As New OpenFileDialog()
        ofd.Filter = _settings.FileDialogFilter
        ofd.Multiselect = True
        ofd.Title = "インポートするファイルを選択"
        
        If ofd.ShowDialog() = DialogResult.OK Then
            AddFiles(ofd.FileNames)
        End If
    End Using
End Sub
```

### 3-4. ファイル追加処理

```vb
' ファイルを追加
Private Sub AddFiles(filePaths As String())
    Dim addedCount As Integer = 0
    Dim errorMessages As New List(Of String)
    
    For Each filePath In filePaths
        ' ディレクトリの場合
        If Directory.Exists(filePath) Then
            If _settings.IncludeSubfolders Then
                Dim dirFiles = Directory.GetFiles(filePath, "*.*", SearchOption.AllDirectories)
                AddFiles(dirFiles)
            Else
                Dim dirFiles = Directory.GetFiles(filePath)
                AddFiles(dirFiles)
            End If
            Continue For
        End If
        
        ' ファイルの場合
        If Not File.Exists(filePath) Then
            errorMessages.Add($"ファイルが見つかりません: {Path.GetFileName(filePath)}")
            Continue For
        End If
        
        Dim fileInfo As New ImportFileInfo(filePath)
        
        ' 検証
        Dim validationResult = ValidateFile(fileInfo)
        If Not validationResult.IsValid Then
            fileInfo.IsValid = False
            fileInfo.ErrorMessage = validationResult.ErrorMessage
            errorMessages.Add($"{fileInfo.FileName}: {validationResult.ErrorMessage}")
        End If
        
        ' 重複チェック
        If Not _settings.AllowDuplicates Then
            If _fileList.Any(Function(f) f.FilePath = filePath) Then
                errorMessages.Add($"既に追加されています: {fileInfo.FileName}")
                Continue For
            End If
        End If
        
        ' ファイル数制限チェック
        If _settings.MaxFileCount > 0 AndAlso _fileList.Count >= _settings.MaxFileCount Then
            errorMessages.Add($"ファイル数の上限に達しました（最大{_settings.MaxFileCount}ファイル）")
            Exit For
        End If
        
        _fileList.Add(fileInfo)
        addedCount += 1
    Next
    
    ' グリッドを更新
    RefreshGrid()
    
    ' エラーメッセージを表示
    If errorMessages.Count > 0 Then
        Dim message = String.Join(Environment.NewLine, errorMessages.Take(10))
        If errorMessages.Count > 10 Then
            message &= Environment.NewLine & $"...他 {errorMessages.Count - 10} 件"
        End If
        MessageBox.Show(message, "ファイル追加の警告", MessageBoxButtons.OK, MessageBoxIcon.Warning)
    End If
    
    If addedCount > 0 Then
        MessageBox.Show($"{addedCount} 件のファイルを追加しました", "完了", MessageBoxButtons.OK, MessageBoxIcon.Information)
    End If
End Sub
```

### 3-5. ファイル検証

```vb
' ファイル検証
Private Function ValidateFile(fileInfo As ImportFileInfo) As (IsValid As Boolean, ErrorMessage As String)
    ' 拡張子チェック
    If _settings.AllowedExtensions IsNot Nothing AndAlso _settings.AllowedExtensions.Length > 0 Then
        If Not _settings.AllowedExtensions.Contains(fileInfo.Extension.ToLower()) Then
            Return (False, $"対応していない形式です（許可: {String.Join(", ", _settings.AllowedExtensions)}）")
        End If
    End If
    
    ' ファイルサイズチェック
    If _settings.MaxFileSize > 0 AndAlso fileInfo.FileSize > _settings.MaxFileSize Then
        Dim maxSizeMB = _settings.MaxFileSize / 1024 / 1024
        Return (False, $"ファイルサイズが大きすぎます（最大{maxSizeMB:F2}MB）")
    End If
    
    ' カスタム検証
    If _settings.CustomValidator IsNot Nothing Then
        Return _settings.CustomValidator(fileInfo)
    End If
    
    Return (True, String.Empty)
End Function
```

### 3-6. グリッド更新とボタン処理

```vb
' グリッドを更新
Private Sub RefreshGrid()
    dgvFiles.DataSource = Nothing
    dgvFiles.DataSource = _fileList
    lblFileCount.Text = $"ファイル数: {_fileList.Count}"
    
    btnRemoveSelected.Enabled = _fileList.Count > 0
    btnClearAll.Enabled = _fileList.Count > 0
    btnOK.Enabled = _fileList.Any(Function(f) f.IsValid)
End Sub

' セルの書式設定（エラー行を赤く表示）
Private Sub DgvFiles_CellFormatting(sender As Object, e As DataGridViewCellFormattingEventArgs)
    If e.RowIndex >= 0 AndAlso e.RowIndex < _fileList.Count Then
        Dim fileInfo = _fileList(e.RowIndex)
        
        ' エラー行は赤く表示
        If Not fileInfo.IsValid Then
            dgvFiles.Rows(e.RowIndex).DefaultCellStyle.BackColor = Color.LightPink
            dgvFiles.Rows(e.RowIndex).DefaultCellStyle.ForeColor = Color.DarkRed
        End If
    End If
End Sub

' 選択削除ボタン
Private Sub BtnRemoveSelected_Click(sender As Object, e As EventArgs)
    If dgvFiles.SelectedRows.Count = 0 Then
        MessageBox.Show("削除するファイルを選択してください", "情報", MessageBoxButtons.OK, MessageBoxIcon.Information)
        Return
    End If
    
    Dim result = MessageBox.Show(
        $"{dgvFiles.SelectedRows.Count} 件のファイルを削除しますか？",
        "確認",
        MessageBoxButtons.YesNo,
        MessageBoxIcon.Question
    )
    
    If result = DialogResult.Yes Then
        ' 後ろから削除（インデックスのズレを防ぐ）
        For i = dgvFiles.SelectedRows.Count - 1 To 0 Step -1
            Dim rowIndex = dgvFiles.SelectedRows(i).Index
            If rowIndex >= 0 AndAlso rowIndex < _fileList.Count Then
                _fileList.RemoveAt(rowIndex)
            End If
        Next
        
        RefreshGrid()
    End If
End Sub

' 全削除ボタン
Private Sub BtnClearAll_Click(sender As Object, e As EventArgs)
    If _fileList.Count = 0 Then
        Return
    End If
    
    Dim result = MessageBox.Show(
        "すべてのファイルをクリアしますか？",
        "確認",
        MessageBoxButtons.YesNo,
        MessageBoxIcon.Question
    )
    
    If result = DialogResult.Yes Then
        _fileList.Clear()
        RefreshGrid()
    End If
End Sub

' OKボタン
Private Sub BtnOK_Click(sender As Object, e As EventArgs)
    ' 有効なファイルのみを返す
    _selectedFiles = _fileList.Where(Function(f) f.IsValid).ToList()
    
    If _selectedFiles.Count = 0 Then
        MessageBox.Show("インポート可能なファイルがありません", "エラー", MessageBoxButtons.OK, MessageBoxIcon.Error)
        Me.DialogResult = DialogResult.None
        Return
    End If
End Sub
```

## 4. 使用例

### 4-1. CSVファイルのインポート

```vb
Public Class MainForm
    Private Sub BtnImportCSV_Click(sender As Object, e As EventArgs) Handles BtnImportCSV.Click
        ' 設定を作成
        Dim settings As New FileImportSettings With {
            .FormTitle = "CSVファイルインポート",
            .Description = "インポートするCSVファイルを選択してください",
            .AllowedExtensions = {".csv", ".txt"},
            .MaxFileSize = 10 * 1024 * 1024, ' 10MB
            .MaxFileCount = 5,
            .AllowDuplicates = False
        }
        
        ' フォームを表示
        Using importForm As New FileImportForm(settings)
            If importForm.ShowDialog() = DialogResult.OK Then
                ' 選択されたファイルを処理
                ProcessCSVFiles(importForm.SelectedFiles)
            End If
        End Using
    End Sub
    
    Private Sub ProcessCSVFiles(files As List(Of ImportFileInfo))
        For Each fileInfo In files
            Try
                ' CSVファイルを読み込んで処理
                Dim lines = File.ReadAllLines(fileInfo.FilePath, System.Text.Encoding.UTF8)
                
                ' ヘッダー行をスキップしてデータを処理
                For i = 1 To lines.Length - 1
                    Dim columns = lines(i).Split(","c)
                    ' データをデータベースに登録
                    ImportCSVRow(columns)
                Next
                
                MessageBox.Show(
                    $"{fileInfo.FileName} を正常にインポートしました（{lines.Length - 1}行）",
                    "成功",
                    MessageBoxButtons.OK,
                    MessageBoxIcon.Information
                )
                
            Catch ex As Exception
                MessageBox.Show(
                    $"{fileInfo.FileName} のインポートに失敗しました: {ex.Message}",
                    "エラー",
                    MessageBoxButtons.OK,
                    MessageBoxIcon.Error
                )
            End Try
        Next
    End Sub
    
    Private Sub ImportCSVRow(columns As String())
        ' 実際のインポート処理
    End Sub
End Class
```

### 4-2. 画像ファイルのインポート（カスタム検証付き）

```vb
Private Sub BtnImportImages_Click(sender As Object, e As EventArgs) Handles BtnImportImages.Click
    Dim settings As New FileImportSettings With {
        .FormTitle = "画像インポート",
        .Description = "インポートする画像ファイルを選択してください",
        .AllowedExtensions = {".jpg", ".jpeg", ".png", ".bmp", ".gif"},
        .MaxFileSize = 5 * 1024 * 1024, ' 5MB
        .AllowDuplicates = True,
        .CustomValidator = Function(fileInfo As ImportFileInfo) As (Boolean, String)
            ' 画像ファイルの追加検証
            Try
                Using img = Image.FromFile(fileInfo.FilePath)
                    ' 画像サイズをチェック
                    If img.Width > 5000 OrElse img.Height > 5000 Then
                        Return (False, "画像サイズが大きすぎます（最大5000x5000px）")
                    End If
                    
                    ' 画像サイズをTagに保存（後で使用可能）
                    fileInfo.Tag = New Size(img.Width, img.Height)
                End Using
                
                Return (True, String.Empty)
            Catch ex As Exception
                Return (False, "画像ファイルとして読み込めません")
            End Try
        End Function
    }
    
    Using importForm As New FileImportForm(settings)
        If importForm.ShowDialog() = DialogResult.OK Then
            ProcessImageFiles(importForm.SelectedFiles)
        End If
    End Using
End Sub

Private Sub ProcessImageFiles(files As List(Of ImportFileInfo))
    For Each fileInfo In files
        Try
            ' 画像をコピーして保存
            Dim destPath = Path.Combine("C:\Images", fileInfo.FileName)
            File.Copy(fileInfo.FilePath, destPath, True)
            
            ' データベースに登録
            Dim imageSize = CType(fileInfo.Tag, Size)
            RegisterImageToDatabase(fileInfo.FileName, imageSize.Width, imageSize.Height)
            
        Catch ex As Exception
            MessageBox.Show($"画像の処理に失敗: {ex.Message}", "エラー", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    Next
    
    MessageBox.Show($"{files.Count} 件の画像をインポートしました", "完了", MessageBoxButtons.OK, MessageBoxIcon.Information)
End Sub

Private Sub RegisterImageToDatabase(fileName As String, width As Integer, height As Integer)
    ' データベース登録処理
End Sub
```

### 4-3. Excelファイルのインポート

```vb
Private Sub BtnImportExcel_Click(sender As Object, e As EventArgs) Handles BtnImportExcel.Click
    Dim settings As New FileImportSettings With {
        .FormTitle = "Excelファイルインポート",
        .Description = "インポートするExcelファイルを選択してください",
        .AllowedExtensions = {".xlsx", ".xls", ".xlsm"},
        .MaxFileSize = 50 * 1024 * 1024, ' 50MB
        .MaxFileCount = 10,
        .AllowDuplicates = False
    }
    
    Using importForm As New FileImportForm(settings)
        If importForm.ShowDialog() = DialogResult.OK Then
            ProcessExcelFiles(importForm.SelectedFiles)
        End If
    End Using
End Sub

Private Sub ProcessExcelFiles(files As List(Of ImportFileInfo))
    ' Excel処理ライブラリ（EPPlusやClosedXMLなど）を使用
    For Each fileInfo In files
        Try
            ' Excelファイルを読み込んで処理
            ' ...
            
            MessageBox.Show($"{fileInfo.FileName} をインポートしました", "成功", MessageBoxButtons.OK, MessageBoxIcon.Information)
            
        Catch ex As Exception
            MessageBox.Show($"エラー: {ex.Message}", "エラー", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    Next
End Sub
```

### 4-4. フォルダのドロップ対応

```vb
Private Sub BtnImportFolder_Click(sender As Object, e As EventArgs) Handles BtnImportFolder.Click
    Dim settings As New FileImportSettings With {
        .FormTitle = "フォルダ内ファイルインポート",
        .Description = "フォルダをドロップするとその中のファイルをすべて読み込みます",
        .AllowedExtensions = {".txt", ".csv"},
        .IncludeSubfolders = True, ' サブフォルダも含める
        .AllowDuplicates = False
    }
    
    Using importForm As New FileImportForm(settings)
        If importForm.ShowDialog() = DialogResult.OK Then
            ' ファイル処理
        End If
    End Using
End Sub
```

## 5. 応用例

### 5-1. プログレスバー付きインポート

```vb
Private Sub ProcessFilesWithProgress(files As List(Of ImportFileInfo))
    Using progressForm As New ProgressForm()
        progressForm.Show()
        
        For i = 0 To files.Count - 1
            Dim fileInfo = files(i)
            
            ' プログレス更新
            progressForm.UpdateProgress(i + 1, files.Count, $"処理中: {fileInfo.FileName}")
            
            Try
                ' ファイル処理
                ProcessFile(fileInfo)
                
            Catch ex As Exception
                ' エラーログ記録
                Debug.WriteLine($"ファイル処理エラー: {fileInfo.FileName} - {ex.Message}")
            End Try
        Next
        
        progressForm.Close()
    End Using
    
    MessageBox.Show("すべてのファイルを処理しました", "完了", MessageBoxButtons.OK, MessageBoxIcon.Information)
End Sub
```

### 5-2. ファイル情報の詳細表示

```vb
Public Class FileImportFormExtended
    Inherits FileImportForm
    
    Private txtFileDetails As TextBox
    
    Protected Overrides Sub OnLoad(e As EventArgs)
        MyBase.OnLoad(e)
        
        ' 詳細表示用のテキストボックスを追加
        txtFileDetails = New TextBox()
        txtFileDetails.Multiline = True
        txtFileDetails.ReadOnly = True
        txtFileDetails.ScrollBars = ScrollBars.Vertical
        txtFileDetails.Location = New Point(780, 35)
        txtFileDetails.Size = New Size(200, 435)
        txtFileDetails.Anchor = AnchorStyles.Top Or AnchorStyles.Bottom Or AnchorStyles.Right
        Me.Controls.Add(txtFileDetails)
        
        ' フォームサイズを拡張
        Me.Size = New Size(1000, 600)
        
        ' 選択変更イベント
        AddHandler dgvFiles.SelectionChanged, AddressOf DgvFiles_SelectionChanged
    End Sub
    
    Private Sub DgvFiles_SelectionChanged(sender As Object, e As EventArgs)
        If dgvFiles.SelectedRows.Count = 1 Then
            Dim fileInfo = CType(dgvFiles.SelectedRows(0).DataBoundItem, ImportFileInfo)
            ShowFileDetails(fileInfo)
        Else
            txtFileDetails.Clear()
        End If
    End Sub
    
    Private Sub ShowFileDetails(fileInfo As ImportFileInfo)
        Dim details As New System.Text.StringBuilder()
        details.AppendLine("【ファイル情報】")
        details.AppendLine()
        details.AppendLine($"ファイル名: {fileInfo.FileName}")
        details.AppendLine($"拡張子: {fileInfo.Extension}")
        details.AppendLine($"サイズ: {fileInfo.FileSizeDisplay}")
        details.AppendLine($"更新日時: {fileInfo.LastModified:yyyy/MM/dd HH:mm:ss}")
        details.AppendLine($"パス: {fileInfo.FilePath}")
        details.AppendLine()
        details.AppendLine($"状態: {If(fileInfo.IsValid, "OK", "エラー")}")
        
        If Not String.IsNullOrEmpty(fileInfo.ErrorMessage) Then
            details.AppendLine($"エラー内容: {fileInfo.ErrorMessage}")
        End If
        
        txtFileDetails.Text = details.ToString()
    End Sub
End Class
```

### 5-3. ドラッグ＆ドロップでの並び替え

```vb
Public Class FileImportFormWithReorder
    Inherits FileImportForm
    
    Private dragRowIndex As Integer = -1
    
    Protected Overrides Sub OnLoad(e As EventArgs)
        MyBase.OnLoad(e)
        
        ' ドラッグ＆ドロップを有効化
        dgvFiles.AllowDrop = True
        AddHandler dgvFiles.MouseDown, AddressOf DgvFiles_MouseDown
        AddHandler dgvFiles.DragOver, AddressOf DgvFiles_DragOver
        AddHandler dgvFiles.DragDrop, AddressOf DgvFiles_DragDropReorder
    End Sub
    
    Private Sub DgvFiles_MouseDown(sender As Object, e As MouseEventArgs)
        If e.Button = MouseButtons.Left Then
            Dim hitTest = dgvFiles.HitTest(e.X, e.Y)
            If hitTest.RowIndex >= 0 Then
                dragRowIndex = hitTest.RowIndex
                dgvFiles.DoDragDrop(dgvFiles.Rows(dragRowIndex), DragDropEffects.Move)
            End If
        End If
    End Sub
    
    Private Sub DgvFiles_DragOver(sender As Object, e As DragEventArgs)
        e.Effect = DragDropEffects.Move
    End Sub
    
    Private Sub DgvFiles_DragDropReorder(sender As Object, e As DragEventArgs)
        Dim clientPoint = dgvFiles.PointToClient(New Point(e.X, e.Y))
        Dim dropRowIndex = dgvFiles.HitTest(clientPoint.X, clientPoint.Y).RowIndex
        
        If dropRowIndex >= 0 AndAlso dragRowIndex >= 0 AndAlso dragRowIndex <> dropRowIndex Then
            ' リスト内のアイテムを並び替え
            Dim item = _fileList(dragRowIndex)
            _fileList.RemoveAt(dragRowIndex)
            _fileList.Insert(dropRowIndex, item)
            
            RefreshGrid()
            dgvFiles.Rows(dropRowIndex).Selected = True
        End If
        
        dragRowIndex = -1
    End Sub
End Class
```

## 6. 重要なポイント

### 6-1. ファイル検証の重要性

```vb
' ✅ 良い例：複数の検証を組み合わせる
Private Function ValidateFile(fileInfo As ImportFileInfo) As (Boolean, String)
    ' 1. 拡張子チェック
    If Not IsAllowedExtension(fileInfo.Extension) Then
        Return (False, "対応していない形式です")
    End If
    
    ' 2. ファイルサイズチェック
    If fileInfo.FileSize > MaxFileSize Then
        Return (False, "ファイルサイズが大きすぎます")
    End If
    
    ' 3. ファイル内容のチェック（カスタム検証）
    If Not ValidateFileContent(fileInfo.FilePath) Then
        Return (False, "ファイル内容が不正です")
    End If
    
    Return (True, String.Empty)
End Function
```

### 6-2. エラーハンドリング

```vb
' ✅ 良い例：各段階でエラーハンドリング
Private Sub AddFiles(filePaths As String())
    Try
        For Each filePath In filePaths
            Try
                Dim fileInfo As New ImportFileInfo(filePath)
                ' 処理
            Catch ex As IOException
                ' ファイルアクセスエラー
                Debug.WriteLine($"ファイルアクセスエラー: {ex.Message}")
            Catch ex As UnauthorizedAccessException
                ' アクセス権限エラー
                Debug.WriteLine($"アクセス権限エラー: {ex.Message}")
            End Try
        Next
    Catch ex As Exception
        ' 予期しないエラー
        MessageBox.Show($"エラーが発生しました: {ex.Message}", "エラー", MessageBoxButtons.OK, MessageBoxIcon.Error)
    End Try
End Sub
```

### 6-3. パフォーマンスの最適化

```vb
' ✅ 良い例：バインディング前にリストを構築
Private Sub AddFiles(filePaths As String())
    ' DataBindingを一時停止
    dgvFiles.DataSource = Nothing
    
    ' ファイルを追加
    For Each filePath In filePaths
        _fileList.Add(New ImportFileInfo(filePath))
    Next
    
    ' 一度だけバインディング
    dgvFiles.DataSource = _fileList
End Sub

' ❌ 悪い例：追加のたびにバインディング
Private Sub AddFiles(filePaths As String())
    For Each filePath In filePaths
        _fileList.Add(New ImportFileInfo(filePath))
        dgvFiles.DataSource = Nothing
        dgvFiles.DataSource = _fileList ' 毎回バインディング = 遅い
    Next
End Sub
```

## 7. トラブルシューティング

### 問題1: ドロップが反応しない

**原因**: `AllowDrop = True`が設定されていない

**解決方法**:
```vb
pnlDropZone.AllowDrop = True ' これを設定
AddHandler pnlDropZone.DragEnter, AddressOf PnlDropZone_DragEnter
AddHandler pnlDropZone.DragDrop, AddressOf PnlDropZone_DragDrop
```

### 問題2: 大量ファイルで動作が遅い

**原因**: DataBindingの頻繁な更新

**解決方法**:
```vb
' バインディングを一時停止
dgvFiles.SuspendLayout()
' ファイル追加処理
dgvFiles.ResumeLayout()
```

### 問題3: 日本語ファイル名が文字化け

**原因**: エンコーディングの問題

**解決方法**:
```vb
' UTF-8で読み込み
Dim lines = File.ReadAllLines(filePath, System.Text.Encoding.UTF8)
```

## 8. まとめ

### 実装した機能一覧

| 機能 | 実装状況 |
|------|---------|
| ドラッグ＆ドロップ | ✅ |
| ファイル選択ダイアログ | ✅ |
| 拡張子フィルター | ✅ |
| ファイルサイズ制限 | ✅ |
| ファイル数制限 | ✅ |
| 重複チェック | ✅ |
| カスタム検証 | ✅ |
| エラー表示 | ✅ |
| 選択削除 | ✅ |
| 全削除 | ✅ |
| ファイル情報表示 | ✅ |

### 設計のメリット

1. **汎用性**: 様々なファイル形式に対応可能
2. **拡張性**: カスタム検証で柔軟に対応
3. **再利用性**: 複数のアプリで使い回し可能
4. **ユーザビリティ**: ドラッグ＆ドロップで直感的
5. **保守性**: 設定クラスで動作を制御

### 今後の拡張案

- プログレスバー表示
- ファイル並び替え機能
- インポート履歴の保存
- ファイル内容のプレビュー
- 非同期処理対応

## おわりに

本記事では、汎用的なファイルインポートフォームの実装方法を解説しました。

この設計により、CSVやExcel、画像など様々な形式のファイルを統一的な方法でインポートできます。

`FileImportSettings`クラスでカスタマイズできるため、アプリケーションごとの要件にも柔軟に対応可能です。

ぜひプロジェクトで活用してください！
